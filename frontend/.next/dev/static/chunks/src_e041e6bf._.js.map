{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["E:/Attack Capital/SignalHub/frontend/src/hooks/useChatSocket.ts"],"sourcesContent":["// src/hooks/useChatSocket.ts\r\n\"use client\";\r\n\r\nimport { useEffect, useRef, useState, useCallback } from \"react\";\r\nimport { io, Socket } from \"socket.io-client\";\r\nimport type { Chat, Message, UserSummary } from \"@/types/chat\";\r\n\r\ntype EventHandlers = {\r\n  onChatCreated?: (chat: Chat) => void;\r\n  onMessageNew?: (message: Message) => void;\r\n  onChatMemberAdded?: (chatId: string, user: UserSummary) => void;\r\n  onChatMemberRemoved?: (chatId: string, userId: string) => void;\r\n  onTyping?: (chatId: string, userId: string, isTyping: boolean) => void;\r\n};\r\n\r\nexport default function useChatSocket(\r\n  token: string | null,\r\n  handlers: EventHandlers = {}\r\n) {\r\n  const socketRef = useRef<Socket | null>(null);\r\n  const [connected, setConnected] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (!token) return;\r\n    // connect to socketio endpoint; server should accept cookie or token auth\r\n    const socket = io(\"/api/socketio\", {\r\n      autoConnect: true,\r\n      auth: { token },\r\n      path: \"/api/socketio\", // in case server uses default\r\n    });\r\n\r\n    socketRef.current = socket;\r\n\r\n    socket.on(\"connect\", () => setConnected(true));\r\n    socket.on(\"disconnect\", () => setConnected(false));\r\n\r\n    socket.on(\"chat:created\", (payload: { chat: Chat }) => {\r\n      handlers.onChatCreated?.(payload.chat);\r\n    });\r\n\r\n    socket.on(\"message:new\", (payload: { message: Message }) => {\r\n      handlers.onMessageNew?.(payload.message);\r\n    });\r\n\r\n    socket.on(\"chat:member:added\", (payload: { chatId: string; user: UserSummary }) => {\r\n      handlers.onChatMemberAdded?.(payload.chatId, payload.user);\r\n    });\r\n\r\n    socket.on(\"chat:member:removed\", (payload: { chatId: string; userId: string }) => {\r\n      handlers.onChatMemberRemoved?.(payload.chatId, payload.userId);\r\n    });\r\n\r\n    socket.on(\"typing\", (payload: { chatId: string; userId: string; isTyping: boolean }) => {\r\n      handlers.onTyping?.(payload.chatId, payload.userId, payload.isTyping);\r\n    });\r\n\r\n    return () => {\r\n      socket.disconnect();\r\n      socketRef.current = null;\r\n    };\r\n  }, [token]);\r\n\r\n  const joinChat = useCallback((chatId: string) => {\r\n    socketRef.current?.emit(\"chat:join\", { chatId });\r\n  }, []);\r\n\r\n  const leaveChat = useCallback((chatId: string) => {\r\n    socketRef.current?.emit(\"chat:leave\", { chatId });\r\n  }, []);\r\n\r\n  const sendMessage = useCallback((chatId: string, content: string) => {\r\n    // prefer REST POST to /api/chats/[chatId]/messages for persistence,\r\n    // but also emit via socket for low-latency if server supports it.\r\n    socketRef.current?.emit(\"message:send\", { chatId, content });\r\n  }, []);\r\n\r\n  const emitTyping = useCallback((chatId: string, isTyping: boolean) => {\r\n    socketRef.current?.emit(\"typing\", { chatId, isTyping });\r\n  }, []);\r\n\r\n  return {\r\n    socket: socketRef.current,\r\n    connected,\r\n    joinChat,\r\n    leaveChat,\r\n    sendMessage,\r\n    emitTyping,\r\n  };\r\n}\r\n"],"names":["useEffect","useRef","useState","useCallback","io","Socket","Chat","Message","UserSummary","EventHandlers","onChatCreated","chat","onMessageNew","message","onChatMemberAdded","chatId","user","onChatMemberRemoved","userId","onTyping","isTyping","useChatSocket","token","handlers","socketRef","connected","setConnected","socket","autoConnect","auth","path","current","on","payload","disconnect","joinChat","emit","leaveChat","sendMessage","content","emitTyping"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 121, "column": 0}, "map": {"version":3,"sources":["E:/Attack Capital/SignalHub/frontend/src/providers/ChatProvider.tsx"],"sourcesContent":["// src/providers/ChatProvider.tsx\r\n\"use client\";\r\n\r\nimport React, { createContext, useContext, useEffect, useMemo, useState } from \"react\";\r\nimport useChatSocket from \"@/hooks/useChatSocket\";\r\nimport type { Chat, Message, UserSummary } from \"@/types/chat\";\r\n\r\n/**\r\n * ChatProvider - holds chat list, active chat, unread counts, and provides helper actions.\r\n *\r\n * Usage:\r\n *  - Wrap your app (or dashboard pages) with <ChatProvider token={authToken}>...</ChatProvider>\r\n *  - Use useChat() hook to access chats, openChat(chatId), sendMessage, etc.\r\n */\r\n\r\ntype ChatContextValue = {\r\n  chats: Chat[];\r\n  setChats: (c: Chat[]) => void;\r\n  activeChatId: string | null;\r\n  openChat: (chatId: string) => void;\r\n  closeChat: () => void;\r\n  sendMessage: (chatId: string, content: string) => Promise<void>;\r\n  addMessageLocally: (message: Message) => void;\r\n  unreadTotal: number;\r\n  loading: boolean;\r\n};\r\n\r\nconst ChatContext = createContext<ChatContextValue | null>(null);\r\n\r\nexport function useChat() {\r\n  const ctx = useContext(ChatContext);\r\n  if (!ctx) throw new Error(\"useChat must be used within ChatProvider\");\r\n  return ctx;\r\n}\r\n\r\nexport function ChatProvider({ token, children }: { token: string | null; children: React.ReactNode }) {\r\n  const [chats, setChats] = useState<Chat[]>([]);\r\n  const [activeChatId, setActiveChatId] = useState<string | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  const handlers = {\r\n    onChatCreated: (chat: Chat) => setChats((prev) => [chat, ...prev]),\r\n    onMessageNew: (message: Message) => {\r\n      // bump lastMessage + unread logic\r\n      setChats((prev) =>\r\n        prev.map((c) => {\r\n          if (c.id === message.chatId) {\r\n            const unread = (c.unreadCount ?? 0) + (activeChatId === c.id ? 0 : 1);\r\n            return { ...c, lastMessage: message, unreadCount: unread };\r\n          }\r\n          return c;\r\n        })\r\n      );\r\n    },\r\n    onChatMemberAdded: (chatId: string, user: UserSummary) => {\r\n      setChats((prev) => prev.map((c) => (c.id === chatId ? { ...c, members: [...(c.members ?? []), user] } : c)));\r\n    },\r\n    onChatMemberRemoved: (chatId: string, userId: string) => {\r\n      setChats((prev) => prev.map((c) => (c.id === chatId ? { ...c, members: (c.members ?? []).filter((m) => m.id !== userId) } : c)));\r\n    },\r\n  };\r\n\r\n  const { socket, connected, joinChat, leaveChat, sendMessage: socketSend } = useChatSocket(token, handlers);\r\n\r\n  // Fetch initial chat list\r\n  useEffect(() => {\r\n    if (!token) {\r\n      setChats([]);\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    setLoading(true);\r\n    fetch(\"/api/chats\")\r\n      .then((r) => r.json())\r\n      .then((data) => {\r\n        if (data?.ok) {\r\n          setChats(data.chats || []);\r\n        } else {\r\n          setChats([]);\r\n        }\r\n      })\r\n      .catch(() => setChats([]))\r\n      .finally(() => setLoading(false));\r\n  }, [token]);\r\n\r\n  useEffect(() => {\r\n    // when opening activeChat, join via socket\r\n    if (activeChatId && socket) {\r\n      joinChat(activeChatId);\r\n    }\r\n    return () => {\r\n      if (activeChatId && socket) leaveChat(activeChatId);\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [activeChatId]);\r\n\r\n  const openChat = (chatId: string) => {\r\n    setActiveChatId(chatId);\r\n    setChats((prev) => prev.map((c) => (c.id === chatId ? { ...c, unreadCount: 0 } : c)));\r\n  };\r\n\r\n  const closeChat = () => setActiveChatId(null);\r\n\r\n  const addMessageLocally = (message: Message) => {\r\n    setChats((prev) =>\r\n      prev.map((c) => (c.id === message.chatId ? { ...c, lastMessage: message } : c))\r\n    );\r\n  };\r\n\r\n  const sendMessage = async (chatId: string, content: string) => {\r\n    // Prefer REST API for durability and server ACLs; also emit socket for low latency.\r\n    try {\r\n      const res = await fetch(`/api/chats/${chatId}`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ content }),\r\n      });\r\n      const json = await res.json();\r\n      if (json?.ok && json?.message) {\r\n        // message will be broadcast by server; optionally also optimistically add\r\n        addMessageLocally(json.message);\r\n      } else {\r\n        // fallback to socket emit\r\n        socketSend(chatId, content);\r\n      }\r\n    } catch (e) {\r\n      // as fallback try socket\r\n      socketSend(chatId, content);\r\n    }\r\n  };\r\n\r\n  const unreadTotal = chats.reduce((sum, c) => sum + (c.unreadCount ?? 0), 0);\r\n\r\n  const ctxValue = useMemo(\r\n    () => ({\r\n      chats,\r\n      setChats,\r\n      activeChatId,\r\n      openChat,\r\n      closeChat,\r\n      sendMessage,\r\n      addMessageLocally,\r\n      unreadTotal,\r\n      loading,\r\n    }),\r\n    [chats, activeChatId, unreadTotal, loading]\r\n  );\r\n\r\n  return <ChatContext.Provider value={ctxValue}>{children}</ChatContext.Provider>;\r\n}\r\n"],"names":["c","_c","React","createContext","useContext","useEffect","useMemo","useState","useChatSocket","Chat","Message","UserSummary","ChatContextValue","chats","setChats","activeChatId","openChat","chatId","closeChat","sendMessage","content","Promise","addMessageLocally","message","unreadTotal","loading","ChatContext","useChat","$","$i","Symbol","for","ctx","Error","ChatProvider","token","children","ReactNode","setActiveChatId","setLoading","handlers","onChatCreated","chat","prev","onMessageNew","map","id","unread","unreadCount","lastMessage","onChatMemberAdded","user","members","onChatMemberRemoved","userId","filter","m","socket","connected","joinChat","leaveChat","socketSend","fetch","then","r","json","data","ok","catch","finally","res","method","headers","body","JSON","stringify","e","reduce","sum","ctxValue"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 322, "column": 0}, "map": {"version":3,"sources":["E:/Attack Capital/SignalHub/frontend/src/components/chat/ComposeBox.tsx"],"sourcesContent":["// src/components/chat/ComposeBox.tsx\r\n\"use client\";\r\n\r\nimport React, { useCallback, useEffect, useRef, useState } from \"react\";\r\nimport socketClient from \"@/lib/socketClient\";\r\nimport { useChat as useChatProvider } from \"@/providers/ChatProvider\";\r\nimport { useChatSocket } from \"@/app/dashboard/ChatSocketProvider\";\r\n\r\n/**\r\n * ComposeBox\r\n *\r\n * Responsibilities:\r\n * - Let user type and send messages (Enter to send, Shift+Enter newline)\r\n * - Emit optimistic socket events for low-latency UX (typing & message post)\r\n * - Upload attachments to /api/upload and include them in payload\r\n * - Prefer provider.sendMessage() if available; fallback to REST POST /api/chats/:id\r\n * - Call onSent for optimistic and server-confirmed messages so parent (TeamChat) can update list\r\n *\r\n * Props:\r\n *  - chatId: string (required)\r\n *  - onSent?: (message) => void  â€” receives optimistic message immediately and server-confirmed later\r\n *  - onError?: (err) => void\r\n */\r\n\r\ntype Sender = { id: string; name?: string | null; role?: string | null; avatarUrl?: string | null } | null;\r\n\r\nexport type Message = {\r\n  id: string;\r\n  chatId: string;\r\n  senderId?: string | null;\r\n  sender?: Sender;\r\n  content: string;\r\n  contentType?: string;\r\n  metadata?: any;\r\n  attachments?: Array<{ id?: string; url?: string; name?: string }>;\r\n  createdAt: string;\r\n};\r\n\r\nexport default function ComposeBox({\r\n  chatId,\r\n  onSent,\r\n  onError,\r\n}: {\r\n  chatId: string;\r\n  onSent?: (m: Message) => void;\r\n  onError?: (e: any) => void;\r\n}) {\r\n  const [text, setText] = useState(\"\");\r\n  const [sending, setSending] = useState(false);\r\n  const [files, setFiles] = useState<File[]>([]);\r\n  const [uploading, setUploading] = useState(false);\r\n  const [status, setStatus] = useState<string | null>(null);\r\n\r\n  const textareaRef = useRef<HTMLTextAreaElement | null>(null);\r\n  const fileInputRef = useRef<HTMLInputElement | null>(null);\r\n  const typingTimerRef = useRef<number | null>(null);\r\n  const lastTypedAtRef = useRef<number | null>(null);\r\n\r\n  // prefer your ChatProvider if available (sendMessage)\r\n  let providerSend: ((chatId: string, content: string, opts?: any) => Promise<any>) | null = null;\r\n  try {\r\n    const prov = useChatProvider?.();\r\n    if (prov && typeof prov.sendMessage === \"function\") providerSend = prov.sendMessage.bind(prov);\r\n  } catch {\r\n    providerSend = null;\r\n  }\r\n\r\n  // socket provider (preferred) or fallback to raw client\r\n  let chatSocket: any = null;\r\n  try {\r\n    chatSocket = useChatSocket();\r\n  } catch {\r\n    chatSocket = null;\r\n  }\r\n\r\n  // -------------------------\r\n  // Helpers\r\n  // -------------------------\r\n  const makeOptimisticMessage = useCallback(\r\n    (content: string, attachments?: Message[\"attachments\"]): Message => {\r\n      return {\r\n        id: `local-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,\r\n        chatId,\r\n        senderId: \"me\",\r\n        sender: { id: \"me\", name: \"You\" },\r\n        content,\r\n        contentType: \"TEXT\",\r\n        metadata: { optimistic: true },\r\n        attachments: attachments ?? [],\r\n        createdAt: new Date().toISOString(),\r\n      };\r\n    },\r\n    [chatId]\r\n  );\r\n\r\n  const emitTyping = useCallback(\r\n    (isTyping: boolean) => {\r\n      try {\r\n        const payload = { chatId, user: { /* server-side will resolve real user */ }, typing: isTyping };\r\n        if (chatSocket && typeof chatSocket.emit === \"function\") {\r\n          chatSocket.emit(\"chat:typing\", payload);\r\n        } else {\r\n          socketClient.emit?.(\"chat:typing\", payload);\r\n        }\r\n      } catch (e) {\r\n        // ignore\r\n      }\r\n    },\r\n    [chatId, chatSocket]\r\n  );\r\n\r\n  // debounce typing â€” call on key press, stop after 1200ms idle\r\n  const notifyTyping = useCallback(() => {\r\n    lastTypedAtRef.current = Date.now();\r\n    // send \"typing\" once immediately\r\n    emitTyping(true);\r\n\r\n    if (typingTimerRef.current) {\r\n      window.clearTimeout(typingTimerRef.current);\r\n    }\r\n\r\n    typingTimerRef.current = window.setTimeout(() => {\r\n      const last = lastTypedAtRef.current ?? 0;\r\n      if (Date.now() - last >= 1100) {\r\n        emitTyping(false);\r\n        typingTimerRef.current = null;\r\n      }\r\n    }, 1200);\r\n  }, [emitTyping]);\r\n\r\n  // autosize textarea\r\n  useEffect(() => {\r\n    const el = textareaRef.current;\r\n    if (!el) return;\r\n    el.style.height = \"auto\";\r\n    const next = Math.min(240, el.scrollHeight);\r\n    el.style.height = `${next}px`;\r\n  }, [text]);\r\n\r\n  // -------------------------\r\n  // File handling & upload\r\n  // -------------------------\r\n  const onFilesSelected = (fl?: FileList | null) => {\r\n    if (!fl) return;\r\n    const arr = Array.from(fl);\r\n    // limit to 5 files to avoid abuse\r\n    const next = [...files, ...arr].slice(0, 5);\r\n    setFiles(next);\r\n  };\r\n\r\n  const removeFile = (idx: number) => setFiles((p) => p.filter((_, i) => i !== idx));\r\n\r\n  async function uploadFiles(): Promise<Message[\"attachments\"]> {\r\n    if (files.length === 0) return [];\r\n    setUploading(true);\r\n    const uploaded: Message[\"attachments\"] = [];\r\n    for (const f of files) {\r\n      try {\r\n        const fd = new FormData();\r\n        fd.append(\"file\", f);\r\n        const res = await fetch(\"/api/upload\", {\r\n          method: \"POST\",\r\n          body: fd,\r\n          credentials: \"same-origin\",\r\n        });\r\n        if (!res.ok) {\r\n          console.warn(\"upload failed\", res.status);\r\n          continue;\r\n        }\r\n        const j = await res.json().catch(() => ({}));\r\n        // try common shapes\r\n        if (j?.file) uploaded.push(j.file);\r\n        else if (j?.url) uploaded.push({ id: j.id ?? String(Date.now()), url: j.url, name: f.name });\r\n        else if (j?.data?.url) uploaded.push({ id: j.data.id ?? String(Date.now()), url: j.data.url, name: f.name });\r\n      } catch (e) {\r\n        console.warn(\"upload error\", e);\r\n      }\r\n    }\r\n    setUploading(false);\r\n    return uploaded;\r\n  }\r\n\r\n  // -------------------------\r\n  // Send flow\r\n  // -------------------------\r\n  const send = useCallback(\r\n    async (ev?: React.SyntheticEvent) => {\r\n      if (ev) ev.preventDefault();\r\n      if (!chatId) return;\r\n      const body = text.trim();\r\n      if (!body && files.length === 0) return;\r\n\r\n      setSending(true);\r\n      setStatus(\"sending\");\r\n\r\n      // optimistic message\r\n      let optimisticAttachments: Message[\"attachments\"] = [];\r\n      // We can show local file names immediately\r\n      if (files.length > 0) {\r\n        optimisticAttachments = files.map((f, idx) => ({ id: `local-file-${idx}-${Date.now()}`, name: f.name }));\r\n      }\r\n      const optimistic = makeOptimisticMessage(body || (files.length ? `(Attachment${files.length > 1 ? \"s\" : \"\"})` : \"\"), optimisticAttachments);\r\n\r\n      try {\r\n        // notify parent immediately with optimistic msg\r\n        try {\r\n          onSent?.(optimistic);\r\n        } catch (e) {\r\n          // swallow user callback errors\r\n          console.warn(\"onSent callback error\", e);\r\n        }\r\n\r\n        // optimistic socket emit so others see it fast\r\n        try {\r\n          const payload = { chatId, message: { content: body, attachments: optimisticAttachments, metadata: { optimistic: true } } };\r\n          if (chatSocket && typeof chatSocket.emit === \"function\") {\r\n            chatSocket.emit(\"chat:post\", payload);\r\n            chatSocket.emit(\"chat:message\", payload);\r\n          } else {\r\n            socketClient.emit?.(\"chat:post\", payload);\r\n            socketClient.emit?.(\"chat:message\", payload);\r\n            socketClient.emit?.(\"message\", payload);\r\n          }\r\n        } catch (e) {\r\n          // ignore emit errors\r\n        }\r\n\r\n        // Upload attachments first, then persist\r\n        const attachments = await uploadFiles();\r\n\r\n        // Build final payload\r\n        const payload = {\r\n          content: body,\r\n          metadata: attachments.length ? { attachments } : undefined,\r\n          attachments: attachments.length ? attachments : undefined,\r\n        };\r\n\r\n        // Prefer provider send if available\r\n        if (providerSend) {\r\n          try {\r\n            const result = await providerSend(chatId, body, { attachments });\r\n            // provider may return message; call onSent with normalized message\r\n            if (result && typeof result === \"object\") {\r\n              const created = result?.message ?? result ?? {};\r\n              const normalized: Message = {\r\n                id: String(created.id ?? created.messageId ?? `srv-${Date.now()}`),\r\n                chatId,\r\n                senderId: created.senderId ?? created.sender?.id ?? null,\r\n                sender: created.sender ?? null,\r\n                content: created.content ?? body,\r\n                contentType: created.contentType ?? \"TEXT\",\r\n                metadata: created.metadata ?? created.meta ?? null,\r\n                attachments: created.attachments ?? attachments ?? [],\r\n                createdAt: created.createdAt ?? new Date().toISOString(),\r\n              };\r\n              onSent?.(normalized);\r\n              setStatus(null);\r\n              setSending(false);\r\n              setText(\"\");\r\n              setFiles([]);\r\n              return;\r\n            }\r\n          } catch (err) {\r\n            console.warn(\"providerSend failed, falling back to REST\", err);\r\n            // fallthrough to REST\r\n          }\r\n        }\r\n\r\n        // REST fallback\r\n        try {\r\n          const res = await fetch(`/api/chats/${encodeURIComponent(chatId)}`, {\r\n            method: \"POST\",\r\n            credentials: \"same-origin\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify(payload),\r\n          });\r\n\r\n          if (res.ok) {\r\n            const j = await res.json().catch(() => ({}));\r\n            const created = j?.message ?? j ?? null;\r\n            if (created) {\r\n              const normalized: Message = {\r\n                id: String(created.id ?? created.messageId ?? `srv-${Date.now()}`),\r\n                chatId,\r\n                senderId: created.senderId ?? created.sender?.id ?? null,\r\n                sender: created.sender ?? null,\r\n                content: created.content ?? body,\r\n                contentType: created.contentType ?? \"TEXT\",\r\n                metadata: created.metadata ?? created.meta ?? null,\r\n                attachments: created.attachments ?? attachments ?? [],\r\n                createdAt: created.createdAt ?? new Date().toISOString(),\r\n              };\r\n              onSent?.(normalized);\r\n              setStatus(null);\r\n              setSending(false);\r\n              setText(\"\");\r\n              setFiles([]);\r\n              return;\r\n            }\r\n          } else {\r\n            console.warn(\"POST /api/chats returned non-OK\", res.status);\r\n            onError?.({ message: `Server error ${res.status}` });\r\n          }\r\n        } catch (err) {\r\n          console.warn(\"POST /api/chats failed\", err);\r\n          onError?.(err);\r\n        }\r\n      } catch (err) {\r\n        console.warn(\"send flow error\", err);\r\n        onError?.(err);\r\n      } finally {\r\n        setStatus(null);\r\n        setSending(false);\r\n      }\r\n    },\r\n    [chatId, text, files, makeOptimisticMessage, onSent, providerSend, chatSocket, onError]\r\n  );\r\n\r\n  // keyboard: Enter to send (no Shift)\r\n  const onKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {\r\n    if (e.key === \"Enter\" && !e.shiftKey) {\r\n      e.preventDefault();\r\n      void send();\r\n    } else {\r\n      // user typed â€” notify typing (debounced)\r\n      notifyTyping();\r\n    }\r\n  };\r\n\r\n  // cleanup on unmount\r\n  useEffect(() => {\r\n    return () => {\r\n      if (typingTimerRef.current) {\r\n        window.clearTimeout(typingTimerRef.current);\r\n        typingTimerRef.current = null;\r\n      }\r\n      emitTyping(false);\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  // small visual: attachments list + accessible labels\r\n  return (\r\n    <form\r\n      onSubmit={(e) => {\r\n        e.preventDefault();\r\n        void send();\r\n      }}\r\n      className=\"space-y-2\"\r\n      aria-live=\"polite\"\r\n    >\r\n      {files.length > 0 && (\r\n        <div className=\"flex gap-2 items-center overflow-auto max-w-full\">\r\n          {files.map((f, i) => (\r\n            <div key={i} className=\"flex items-center gap-2 px-2 py-1 bg-slate-50 border rounded text-xs\">\r\n              <div className=\"truncate max-w-[200px]\" title={f.name}>\r\n                {f.name}\r\n              </div>\r\n              <button\r\n                type=\"button\"\r\n                aria-label={`Remove ${f.name}`}\r\n                onClick={() => removeFile(i)}\r\n                className=\"text-rose-600 font-bold px-1\"\r\n              >\r\n                Ã—\r\n              </button>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"flex gap-2 items-end\">\r\n        <textarea\r\n          ref={textareaRef}\r\n          value={text}\r\n          onChange={(e) => setText(e.target.value)}\r\n          onKeyDown={onKeyDown}\r\n          placeholder=\"Write a message...\"\r\n          aria-label=\"Type a message\"\r\n          className=\"flex-1 min-h-[44px] max-h-[240px] resize-none border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n          rows={2}\r\n          disabled={sending}\r\n        />\r\n\r\n        <div className=\"flex flex-col items-stretch gap-2\">\r\n          <input\r\n            ref={fileInputRef}\r\n            type=\"file\"\r\n            multiple\r\n            className=\"hidden\"\r\n            onChange={(e) => onFilesSelected(e.target.files)}\r\n            aria-hidden\r\n          />\r\n          <div className=\"flex gap-2\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => fileInputRef.current?.click()}\r\n              className=\"px-3 py-2 bg-slate-50 border rounded hover:bg-slate-100\"\r\n              aria-label=\"Attach files\"\r\n              title=\"Attach files\"\r\n              disabled={uploading || sending}\r\n            >\r\n              ðŸ“Ž\r\n            </button>\r\n\r\n            <button\r\n              type=\"submit\"\r\n              disabled={sending || uploading || (!text.trim() && files.length === 0)}\r\n              className={`px-4 py-2 rounded text-white ${sending ? \"bg-slate-300 cursor-wait\" : \"bg-blue-600 hover:bg-blue-700\"}`}\r\n              aria-label=\"Send message\"\r\n            >\r\n              {sending ? \"Sendingâ€¦\" : \"Send\"}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* status text for screen readers & users */}\r\n      <div className=\"text-xs text-slate-500\" aria-live=\"polite\">\r\n        {uploading ? \"Uploading attachmentsâ€¦ \" : null}\r\n        {status ? status : null}\r\n      </div>\r\n    </form>\r\n  );\r\n}\r\n"],"names":["React","useCallback","useEffect","useRef","useState","socketClient","useChat","useChatProvider","useChatSocket","Sender","id","name","role","avatarUrl","Message","chatId","senderId","sender","content","contentType","metadata","attachments","Array","url","createdAt","ComposeBox","onSent","onError","m","e","text","setText","sending","setSending","files","setFiles","File","uploading","setUploading","status","setStatus","textareaRef","HTMLTextAreaElement","fileInputRef","HTMLInputElement","typingTimerRef","lastTypedAtRef","providerSend","opts","Promise","prov","sendMessage","bind","chatSocket","makeOptimisticMessage","Date","now","Math","random","toString","slice","optimistic","toISOString","emitTyping","isTyping","payload","user","typing","emit","notifyTyping","current","window","clearTimeout","setTimeout","last","el","style","height","next","min","scrollHeight","onFilesSelected","fl","FileList","arr","from","removeFile","idx","p","filter","_","i","uploadFiles","length","uploaded","f","fd","FormData","append","res","fetch","method","body","credentials","ok","console","warn","j","json","catch","file","push","String","data","send","ev","SyntheticEvent","preventDefault","trim","optimisticAttachments","map","message","undefined","result","created","normalized","messageId","meta","err","encodeURIComponent","headers","JSON","stringify","onKeyDown","KeyboardEvent","key","shiftKey","target","value","click"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 832, "column": 0}, "map": {"version":3,"sources":["E:/Attack Capital/SignalHub/frontend/src/components/chat/TeamChat.tsx"],"sourcesContent":["// src/components/chat/TeamChat.tsx\r\n\"use client\";\r\n\r\nimport React, {\r\n  useCallback,\r\n  useEffect,\r\n  useRef,\r\n  useState,\r\n} from \"react\";\r\nimport socketClient from \"@/lib/socketClient\";\r\nimport ComposeBox, {\r\n  Message as OutgoingMessage,\r\n} from \"@/components/chat/ComposeBox\";\r\nimport { useChatSocket } from \"@/app/dashboard/ChatSocketProvider\";\r\n\r\ntype MinimalUser = {\r\n  id?: string | number | null;\r\n  name?: string | null;\r\n  email?: string | null;\r\n  role?: string | null;\r\n};\r\n\r\nexport type ChatMessage = {\r\n  id?: string | null;\r\n  chatId?: string | null;\r\n  content: string;\r\n  metadata?: any;\r\n  externalId?: string | null;\r\n  createdAt?: string | null;\r\n  sender?:\r\n    | {\r\n        id?: string | number | null;\r\n        name?: string | null;\r\n        email?: string | null;\r\n      }\r\n    | null;\r\n  attachments?: Array<{ id?: string; url?: string; name?: string }>;\r\n  __localId?: string; // client-only\r\n};\r\n\r\ntype ChatInfo = {\r\n  id: string;\r\n  name?: string | null;\r\n  type?: \"team\" | \"direct\" | string | null;\r\n  participants?: MinimalUser[] | undefined;\r\n  meta?: any;\r\n};\r\n\r\nconst genLocalId = (prefix = \"local-\") =>\r\n  `${prefix}${Math.random().toString(36).slice(2, 9)}`;\r\n\r\n/** Robust display name derivation for header */\r\nfunction deriveChatDisplayName(\r\n  info: ChatInfo | null,\r\n  me?: MinimalUser | null\r\n) {\r\n  if (!info) return \"Chat\";\r\n\r\n  const t = info.type?.toString().toLowerCase();\r\n  const serverName =\r\n    (info.name ??\r\n      info.meta?.teamName ??\r\n      info.meta?.name ??\r\n      \"\") || \"\";\r\n  const isGenericServerName =\r\n    serverName.trim() === \"\" ||\r\n    serverName === \"Chat\" ||\r\n    serverName.startsWith(\"Chat \");\r\n\r\n  // DIRECT: prefer other participant\r\n  if (t === \"direct\") {\r\n    const participants: MinimalUser[] | undefined =\r\n      info.participants ??\r\n      info.meta?.participants ??\r\n      info.meta?.members;\r\n\r\n    if (participants && participants.length > 0 && me?.id != null) {\r\n      const other = participants.find(\r\n        (p) => p && String(p.id) !== String(me.id)\r\n      );\r\n      if (other?.name) return other.name;\r\n      if (other?.email) return other.email;\r\n    }\r\n\r\n    // last message sender\r\n    const lastSender =\r\n      info.meta?.lastMessage?.senderName ??\r\n      info.meta?.lastMessage?.sender?.name ??\r\n      null;\r\n    if (lastSender) return lastSender;\r\n\r\n    if (!isGenericServerName && serverName) return serverName;\r\n\r\n    return \"Direct chat\";\r\n  }\r\n\r\n  // TEAM / group\r\n  if (!isGenericServerName && serverName) return serverName;\r\n  return `Team ${info.id ?? \"\"}`;\r\n}\r\n\r\nexport default function TeamChat({\r\n  chatId,\r\n  currentUser,\r\n}: {\r\n  chatId: string;\r\n  currentUser?: MinimalUser | null;\r\n}) {\r\n  const [messages, setMessages] = useState<ChatMessage[]>([]);\r\n  const [info, setInfo] = useState<ChatInfo | null>(null);\r\n  const [loading, setLoading] = useState<boolean>(true);\r\n  const [typingUsers, setTypingUsers] = useState<\r\n    Record<string, boolean>\r\n  >({});\r\n\r\n  const listRef = useRef<HTMLDivElement | null>(null);\r\n\r\n  // edit/delete UI state\r\n  const [editingMessageId, setEditingMessageId] =\r\n    useState<string | null>(null);\r\n  const [editingDraft, setEditingDraft] = useState<string>(\"\");\r\n  const [hiddenForClient, setHiddenForClient] = useState<\r\n    Record<string, boolean>\r\n  >({});\r\n\r\n  // try provider socket first\r\n  let chatSocket: any = null;\r\n  try {\r\n    chatSocket = useChatSocket();\r\n  } catch {\r\n    chatSocket = null;\r\n  }\r\n\r\n  // dedupe & scroll helpers\r\n  const seenIdsRef = useRef<Set<string>>(new Set());\r\n  const localToServerIdRef = useRef<Record<string, string>>({});\r\n  const isNearBottomRef = useRef<boolean>(true);\r\n  const mountedRef = useRef(true);\r\n\r\n  const markRead = useCallback(async () => {\r\n    try {\r\n      await fetch(\r\n        `/api/chats/${encodeURIComponent(chatId)}/read`,\r\n        { method: \"POST\", credentials: \"same-origin\" }\r\n      );\r\n    } catch {\r\n      // best-effort\r\n    }\r\n  }, [chatId]);\r\n\r\n  /* ------------------------\r\n     load chat info + history\r\n     ------------------------ */\r\n  useEffect(() => {\r\n    mountedRef.current = true;\r\n    const controller = new AbortController();\r\n\r\n    const load = async () => {\r\n      setLoading(true);\r\n      try {\r\n        // 1) messages from /api/chats/[chatId]\r\n        const res = await fetch(\r\n          `/api/chats/${encodeURIComponent(chatId)}`,\r\n          { credentials: \"same-origin\", signal: controller.signal }\r\n        );\r\n\r\n        let json: any = {};\r\n        if (res.ok) {\r\n          json = await res.json().catch(() => ({}));\r\n        } else {\r\n          try {\r\n            json = await res.json().catch(() => ({}));\r\n          } catch {\r\n            json = {};\r\n          }\r\n        }\r\n\r\n        const msgs =\r\n          (json?.messages ??\r\n            json?.messages_list ??\r\n            json?.items ??\r\n            json?.rows ??\r\n            []) as ChatMessage[];\r\n\r\n        const normalized = (Array.isArray(msgs) ? msgs : []).map(\r\n          (m) => {\r\n            const id =\r\n              m?.id ??\r\n              m?.externalId ??\r\n              m?.messageId ??\r\n              genLocalId(\"srv-\");\r\n            seenIdsRef.current.add(String(id));\r\n            return { ...m, id: String(id) } as ChatMessage;\r\n          }\r\n        );\r\n\r\n        if (!mountedRef.current) return;\r\n        setMessages(normalized);\r\n\r\n        // 2) chat meta from /api/chats (chat list)\r\n        try {\r\n          const metaRes = await fetch(\"/api/chats\", {\r\n            credentials: \"same-origin\",\r\n            signal: controller.signal,\r\n          });\r\n          if (metaRes.ok) {\r\n            const metaJson = await metaRes.json().catch(() => ({}));\r\n            const list = metaJson?.chats ?? metaJson?.items ?? [];\r\n            const found = (Array.isArray(list)\r\n              ? list\r\n              : []\r\n            ).find((c: any) => String(c.id) === String(chatId));\r\n\r\n            if (found) {\r\n              const participants: MinimalUser[] | undefined =\r\n                Array.isArray(found.members)\r\n                  ? found.members.map((m: any) => ({\r\n                      id: m.id,\r\n                      name: m.name,\r\n                      email: m.email,\r\n                      role: m.role ?? null,\r\n                    }))\r\n                  : undefined;\r\n\r\n              const chatInfo: ChatInfo = {\r\n                id: String(found.id),\r\n                name: found.name ?? null,\r\n                type: found.type ?? null,\r\n                participants,\r\n                meta: found,\r\n              };\r\n              setInfo(chatInfo);\r\n            } else {\r\n              // fallback if not in list\r\n              setInfo((prev) =>\r\n                prev ?? {\r\n                  id: chatId,\r\n                  name: json?.name ?? null,\r\n                  type: json?.type ?? null,\r\n                  participants:\r\n                    json?.participants ??\r\n                    json?.members ??\r\n                    json?.users ??\r\n                    undefined,\r\n                  meta: json ?? null,\r\n                }\r\n              );\r\n            }\r\n          } else {\r\n            // meta call failed â€” keep whatever we might have from json\r\n            setInfo((prev) =>\r\n              prev ?? {\r\n                id: chatId,\r\n                name: json?.name ?? null,\r\n                type: json?.type ?? null,\r\n                participants:\r\n                  json?.participants ??\r\n                  json?.members ??\r\n                  json?.users ??\r\n                  undefined,\r\n                meta: json ?? null,\r\n              }\r\n            );\r\n          }\r\n        } catch {\r\n          // ignore meta fetch errors\r\n          setInfo((prev) =>\r\n            prev ?? {\r\n              id: chatId,\r\n              name: json?.name ?? null,\r\n              type: json?.type ?? null,\r\n              participants:\r\n                json?.participants ??\r\n                json?.members ??\r\n                json?.users ??\r\n                undefined,\r\n              meta: json ?? null,\r\n            }\r\n          );\r\n        }\r\n\r\n        // mark read\r\n        void markRead();\r\n      } catch (err: any) {\r\n        if (err?.name === \"AbortError\") return;\r\n        console.warn(\"TeamChat load error:\", err);\r\n      } finally {\r\n        if (mountedRef.current) setLoading(false);\r\n      }\r\n    };\r\n\r\n    void load();\r\n\r\n    // join room\r\n    (async () => {\r\n      try {\r\n        if (\r\n          chatSocket &&\r\n          typeof chatSocket.joinChat === \"function\"\r\n        ) {\r\n          await chatSocket.joinChat(chatId);\r\n        } else if (\r\n          socketClient &&\r\n          typeof socketClient.emit === \"function\"\r\n        ) {\r\n          socketClient.emit(\"join-room\", chatId);\r\n        }\r\n      } catch {\r\n        // ignore join errors (best-effort)\r\n      }\r\n    })();\r\n\r\n    return () => {\r\n      mountedRef.current = false;\r\n      controller.abort();\r\n      try {\r\n        if (\r\n          chatSocket &&\r\n          typeof chatSocket.leaveChat === \"function\"\r\n        ) {\r\n          chatSocket.leaveChat(chatId).catch(() => {});\r\n        } else if (\r\n          socketClient &&\r\n          typeof socketClient.emit === \"function\"\r\n        ) {\r\n          socketClient.emit(\"leave-room\", chatId);\r\n        }\r\n      } catch {}\r\n    };\r\n  }, [chatId, chatSocket, markRead]);\r\n\r\n  /* ------------------------\r\n     socket subscriptions\r\n     ------------------------ */\r\n  useEffect(() => {\r\n    if (\r\n      !chatSocket &&\r\n      (!socketClient || typeof socketClient.on !== \"function\")\r\n    )\r\n      return;\r\n\r\n    const handleMessage = (payload: any) => {\r\n      try {\r\n        let incomingChatId =\r\n          payload?.chatId ??\r\n          payload?.room ??\r\n          payload?.message?.chatId ??\r\n          payload?.chat?.id ??\r\n          null;\r\n\r\n        // normalize room like \"chat:<id>\" â†’ \"<id>\"\r\n        if (\r\n          typeof incomingChatId === \"string\" &&\r\n          incomingChatId.startsWith(\"chat:\")\r\n        ) {\r\n          incomingChatId = incomingChatId.slice(\"chat:\".length);\r\n        }\r\n\r\n        if (\r\n          incomingChatId &&\r\n          String(incomingChatId) !== String(chatId)\r\n        )\r\n          return;\r\n\r\n        const msg = payload?.message ?? payload;\r\n        if (!msg) return;\r\n\r\n        const serverId =\r\n          msg?.id ?? msg?.externalId ?? msg?.messageId ?? null;\r\n        const content = msg?.content ?? msg?.text ?? \"\";\r\n        const sender = msg?.sender ?? msg?.from ?? msg?.user ?? null;\r\n        const createdAt =\r\n          msg?.createdAt ??\r\n          msg?.ts ??\r\n          msg?.created_at ??\r\n          new Date().toISOString();\r\n\r\n        if (serverId && seenIdsRef.current.has(String(serverId)))\r\n          return;\r\n\r\n        setMessages((prev) => {\r\n          const optimisticIdx = prev.findIndex((p) => {\r\n            if (!p) return false;\r\n            if (\r\n              typeof p.id === \"string\" &&\r\n              p.id.startsWith(\"local-\") &&\r\n              serverId\r\n            ) {\r\n              if (\r\n                p.content === content &&\r\n                ((p.sender?.id &&\r\n                  sender?.id &&\r\n                  String(p.sender.id) === String(sender.id)) ||\r\n                  (p.sender?.name &&\r\n                    sender?.name &&\r\n                    p.sender.name === sender.name))\r\n              )\r\n                return true;\r\n            }\r\n            return (\r\n              typeof p.id === \"string\" &&\r\n              p.id.startsWith(\"local-\") &&\r\n              p.content === content &&\r\n              p.sender?.name &&\r\n              sender?.name &&\r\n              p.sender.name === sender.name\r\n            );\r\n          });\r\n\r\n          if (optimisticIdx >= 0 && serverId) {\r\n            const copy = [...prev];\r\n            const oldLocalId = copy[optimisticIdx].id as string;\r\n            const newMsg: ChatMessage = {\r\n              ...msg,\r\n              id: String(serverId),\r\n              content,\r\n              createdAt,\r\n              sender: sender\r\n                ? {\r\n                    id:\r\n                      sender.id ??\r\n                      sender.userId ??\r\n                      sender,\r\n                    name:\r\n                      sender.name ??\r\n                      sender.fullName ??\r\n                      null,\r\n                  }\r\n                : null,\r\n              metadata: msg?.metadata ?? msg?.meta ?? undefined,\r\n              attachments: msg?.attachments ?? msg?.files ?? undefined,\r\n            };\r\n            copy[optimisticIdx] = newMsg;\r\n            if (oldLocalId) {\r\n              seenIdsRef.current.delete(oldLocalId);\r\n              localToServerIdRef.current[oldLocalId] =\r\n                String(serverId);\r\n            }\r\n            seenIdsRef.current.add(String(serverId));\r\n            return copy;\r\n          }\r\n\r\n          const idToUse = serverId\r\n            ? String(serverId)\r\n            : genLocalId(\"local-\");\r\n          seenIdsRef.current.add(idToUse);\r\n          const appended: ChatMessage = {\r\n            id: idToUse,\r\n            chatId,\r\n            content,\r\n            sender: sender\r\n              ? {\r\n                  id:\r\n                    sender.id ??\r\n                    sender.userId ??\r\n                    sender,\r\n                  name:\r\n                    sender.name ??\r\n                    sender.fullName ??\r\n                    null,\r\n                }\r\n              : null,\r\n            attachments: msg?.attachments ?? msg?.files ?? undefined,\r\n            createdAt,\r\n            metadata: msg?.metadata ?? msg?.meta ?? undefined,\r\n          };\r\n          return [...prev, appended];\r\n        });\r\n\r\n        // ensure participants include sender (helps header name + inbox)\r\n        if (sender) {\r\n          setInfo((prev) => {\r\n            if (!prev) return prev;\r\n            const existing = prev.participants ?? [];\r\n            const existingIds = new Set(\r\n              existing.map((p) => String(p?.id))\r\n            );\r\n            const senderId =\r\n              sender?.id ?? sender?.userId ?? sender;\r\n            if (senderId && !existingIds.has(String(senderId))) {\r\n              const added = [\r\n                ...existing,\r\n                {\r\n                  id: senderId,\r\n                  name: sender?.name ?? null,\r\n                  email: sender?.email ?? null,\r\n                },\r\n              ];\r\n              return {\r\n                ...prev,\r\n                participants: added,\r\n                meta: { ...prev.meta, lastMessage: msg },\r\n              };\r\n            }\r\n            return {\r\n              ...prev,\r\n              meta: { ...prev.meta, lastMessage: msg },\r\n            };\r\n          });\r\n        }\r\n      } catch (e) {\r\n        console.warn(\"incoming message handling error:\", e);\r\n      }\r\n    };\r\n\r\n    const handleTyping = (payload: any) => {\r\n      try {\r\n        let whichChat =\r\n          payload?.chatId ?? payload?.room ?? null;\r\n        if (\r\n          typeof whichChat === \"string\" &&\r\n          whichChat.startsWith(\"chat:\")\r\n        ) {\r\n          whichChat = whichChat.slice(\"chat:\".length);\r\n        }\r\n        if (!whichChat || String(whichChat) !== String(chatId))\r\n          return;\r\n        const user =\r\n          payload?.user ?? payload?.userId ?? payload?.sender ?? null;\r\n        const userId =\r\n          user &&\r\n          (typeof user === \"string\"\r\n            ? user\r\n            : user.id ?? user.userId ?? null);\r\n        if (!userId) return;\r\n        setTypingUsers((prev) => ({\r\n          ...prev,\r\n          [String(userId)]: true,\r\n        }));\r\n        window.setTimeout(() => {\r\n          setTypingUsers((prev) => {\r\n            const copy = { ...prev };\r\n            delete copy[String(userId)];\r\n            return copy;\r\n          });\r\n        }, 1800);\r\n      } catch {}\r\n    };\r\n\r\n    // Handle remote edits/deletes from backend:\r\n    // backend emits: \"chat:message:updated\" { chatId, action: \"edit\" | \"delete\", message: {...} }\r\n    const handleMessageUpdated = (payload: any) => {\r\n      try {\r\n        let incomingChatId =\r\n          payload?.chatId ??\r\n          payload?.message?.chatId ??\r\n          null;\r\n\r\n        if (\r\n          typeof incomingChatId === \"string\" &&\r\n          incomingChatId.startsWith(\"chat:\")\r\n        ) {\r\n          incomingChatId = incomingChatId.slice(\"chat:\".length);\r\n        }\r\n\r\n        if (\r\n          incomingChatId &&\r\n          String(incomingChatId) !== String(chatId)\r\n        )\r\n          return;\r\n\r\n        const action = payload?.action ?? null;\r\n        const msg = payload?.message ?? null;\r\n        if (!msg || !msg.id) return;\r\n\r\n        const serverId = String(msg.id);\r\n\r\n        setMessages((prev) =>\r\n          prev.map((m) => {\r\n            if (String(m.id) !== serverId) return m;\r\n\r\n            const base: ChatMessage = {\r\n              ...m,\r\n              content: msg.content ?? m.content,\r\n              metadata: msg.metadata ?? m.metadata ?? {},\r\n              externalId: msg.externalId ?? m.externalId,\r\n              createdAt:\r\n                msg.createdAt ??\r\n                m.createdAt ??\r\n                new Date().toISOString(),\r\n              sender: msg.sender ?? m.sender ?? null,\r\n            };\r\n\r\n            if (action === \"delete\") {\r\n              const isDeletedForAll =\r\n                !!base.metadata?.deletedForEveryone ||\r\n                !!base.metadata?.deletedForAll;\r\n              if (isDeletedForAll) {\r\n                return {\r\n                  ...base,\r\n                  content: \"This message was deleted\",\r\n                };\r\n              }\r\n            }\r\n\r\n            if (action === \"edit\") {\r\n              return {\r\n                ...base,\r\n                metadata: {\r\n                  ...base.metadata,\r\n                  edited: true,\r\n                },\r\n              };\r\n            }\r\n\r\n            return base;\r\n          })\r\n        );\r\n      } catch (e) {\r\n        console.warn(\"message updated handler error:\", e);\r\n      }\r\n    };\r\n\r\n    try {\r\n      if (chatSocket && typeof chatSocket.on === \"function\") {\r\n        chatSocket.on(\"chat:message\", handleMessage);\r\n        chatSocket.on(\"message\", handleMessage);\r\n        chatSocket.on(\"typing\", handleTyping);\r\n        chatSocket.on(\"chat:message:updated\", handleMessageUpdated);\r\n      } else {\r\n        socketClient.on(\"chat:message\", handleMessage);\r\n        socketClient.on(\"message\", handleMessage);\r\n        socketClient.on(\"typing\", handleTyping);\r\n        socketClient.on(\"chat:message:updated\", handleMessageUpdated);\r\n      }\r\n    } catch {\r\n      // ignore\r\n    }\r\n\r\n    return () => {\r\n      try {\r\n        if (chatSocket && typeof chatSocket.off === \"function\") {\r\n          chatSocket.off(\"chat:message\", handleMessage);\r\n          chatSocket.off(\"message\", handleMessage);\r\n          chatSocket.off(\"typing\", handleTyping);\r\n          chatSocket.off(\"chat:message:updated\", handleMessageUpdated);\r\n        } else {\r\n          socketClient.off(\"chat:message\", handleMessage);\r\n          socketClient.off(\"message\", handleMessage);\r\n          socketClient.off(\"typing\", handleTyping);\r\n          socketClient.off(\"chat:message:updated\", handleMessageUpdated);\r\n        }\r\n      } catch {}\r\n    };\r\n  }, [chatId, chatSocket]);\r\n\r\n  /* ------------------------\r\n     scrolling behaviour\r\n     ------------------------ */\r\n  useEffect(() => {\r\n    const el = listRef.current;\r\n    if (!el) return;\r\n    const onScroll = () => {\r\n      const remaining =\r\n        el.scrollHeight - (el.scrollTop + el.clientHeight);\r\n      isNearBottomRef.current = remaining < 160;\r\n    };\r\n    el.addEventListener(\"scroll\", onScroll);\r\n    return () => el.removeEventListener(\"scroll\", onScroll);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const el = listRef.current;\r\n    if (!el) return;\r\n    if (isNearBottomRef.current) {\r\n      requestAnimationFrame(() => {\r\n        try {\r\n          el.scrollTo({\r\n            top: el.scrollHeight,\r\n            behavior: \"smooth\",\r\n          });\r\n        } catch {\r\n          el.scrollTop = el.scrollHeight;\r\n        }\r\n      });\r\n    }\r\n  }, [messages.length]);\r\n\r\n  /* ------------------------\r\n     outgoing handler (ComposeBox)\r\n     ------------------------ */\r\n  const handleOutgoing = async (m: OutgoingMessage) => {\r\n    try {\r\n      const isLocal =\r\n        typeof m.id === \"string\" && m.id.startsWith(\"local-\");\r\n      if (isLocal) {\r\n        if (!seenIdsRef.current.has(String(m.id))) {\r\n          seenIdsRef.current.add(String(m.id));\r\n          const localMsg: ChatMessage = {\r\n            id: String(m.id),\r\n            chatId,\r\n            content: m.content,\r\n            sender: {\r\n              id: m.senderId ?? currentUser?.id,\r\n              name:\r\n                m.senderName ?? currentUser?.name ?? null,\r\n            },\r\n            attachments: m.attachments ?? undefined,\r\n            createdAt:\r\n              m.createdAt ?? new Date().toISOString(),\r\n            __localId: String(m.id),\r\n          };\r\n          setMessages((prev) => [...prev, localMsg]);\r\n        }\r\n        return;\r\n      }\r\n\r\n      setMessages((prev) => {\r\n        const localKey = Object.keys(\r\n          localToServerIdRef.current\r\n        ).find(\r\n          (lk) => localToServerIdRef.current[lk] === m.id\r\n        );\r\n        if (localKey) {\r\n          const idx = prev.findIndex((p) => p.id === localKey);\r\n          if (idx >= 0) {\r\n            const copy = [...prev];\r\n            const newMsg: ChatMessage = {\r\n              id: String(m.id),\r\n              chatId,\r\n              content: m.content,\r\n              sender: {\r\n                id: m.senderId ?? currentUser?.id,\r\n                name:\r\n                  m.senderName ?? currentUser?.name ?? null,\r\n              },\r\n              createdAt:\r\n                m.createdAt ?? new Date().toISOString(),\r\n              attachments: m.attachments ?? undefined,\r\n            };\r\n            copy[idx] = newMsg;\r\n            seenIdsRef.current.delete(localKey);\r\n            seenIdsRef.current.add(String(m.id));\r\n            localToServerIdRef.current[localKey] =\r\n              String(m.id);\r\n            return copy;\r\n          }\r\n        }\r\n\r\n        const optIdx = prev.findIndex(\r\n          (p) =>\r\n            typeof p.id === \"string\" &&\r\n            p.id.startsWith(\"local-\") &&\r\n            p.content === m.content &&\r\n            ((p.sender?.id &&\r\n              String(p.sender.id) ===\r\n                String(m.senderId)) ||\r\n              (p.sender?.name &&\r\n                p.sender.name === m.senderName))\r\n        );\r\n        if (optIdx >= 0) {\r\n          const copy = [...prev];\r\n          const oldLocalId = copy[optIdx].id as string;\r\n          const newMsg: ChatMessage = {\r\n            id: String(m.id),\r\n            chatId,\r\n            content: m.content,\r\n            sender: {\r\n              id: m.senderId ?? currentUser?.id,\r\n              name:\r\n                m.senderName ?? currentUser?.name ?? null,\r\n            },\r\n            createdAt:\r\n              m.createdAt ?? new Date().toISOString(),\r\n            attachments: m.attachments ?? undefined,\r\n          };\r\n          copy[optIdx] = newMsg;\r\n          if (oldLocalId) {\r\n            seenIdsRef.current.delete(oldLocalId);\r\n            localToServerIdRef.current[oldLocalId] =\r\n              String(m.id);\r\n          }\r\n          seenIdsRef.current.add(String(m.id));\r\n          return copy;\r\n        }\r\n\r\n        if (m.id && seenIdsRef.current.has(String(m.id)))\r\n          return prev;\r\n        if (m.id) seenIdsRef.current.add(String(m.id));\r\n        const appended: ChatMessage = {\r\n          id: String(m.id ?? genLocalId(\"srv-\")),\r\n          chatId,\r\n          content: m.content,\r\n          sender: {\r\n            id: m.senderId ?? currentUser?.id,\r\n            name:\r\n              m.senderName ?? currentUser?.name ?? null,\r\n          },\r\n          createdAt:\r\n            m.createdAt ?? new Date().toISOString(),\r\n          attachments: m.attachments ?? undefined,\r\n        };\r\n        return [...prev, appended];\r\n      });\r\n\r\n      void markRead();\r\n    } catch (err) {\r\n      console.warn(\"handleOutgoing error:\", err);\r\n    }\r\n  };\r\n\r\n  /* ------------------------\r\n     edit / delete handlers\r\n     ------------------------ */\r\n  const handleStartEdit = (msg: ChatMessage) => {\r\n    if (!msg.id) return;\r\n    setEditingMessageId(String(msg.id));\r\n    setEditingDraft(msg.content);\r\n  };\r\n\r\n  const handleCancelEdit = () => {\r\n    setEditingMessageId(null);\r\n    setEditingDraft(\"\");\r\n  };\r\n\r\n  const handleConfirmEdit = async (\r\n    msg: ChatMessage,\r\n    newContent: string\r\n  ) => {\r\n    if (!msg.id) return;\r\n    const idStr = String(msg.id);\r\n    const trimmed = newContent.trim();\r\n    if (!trimmed) {\r\n      // do not allow empty content on client\r\n      return;\r\n    }\r\n\r\n    // optimistic local update\r\n    setMessages((prev) =>\r\n      prev.map((m) =>\r\n        String(m.id) === idStr\r\n          ? {\r\n              ...m,\r\n              content: trimmed,\r\n              metadata: {\r\n                ...m.metadata,\r\n                edited: true,\r\n              },\r\n            }\r\n          : m\r\n      )\r\n    );\r\n    setEditingMessageId(null);\r\n    setEditingDraft(\"\");\r\n\r\n    // best-effort: call backend PATCH /api/chats/[chatId]\r\n    try {\r\n      await fetch(\r\n        `/api/chats/${encodeURIComponent(chatId)}`,\r\n        {\r\n          method: \"PATCH\",\r\n          credentials: \"same-origin\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n          },\r\n          body: JSON.stringify({\r\n            messageId: idStr,\r\n            content: trimmed,\r\n          }),\r\n        }\r\n      ).catch(() => {});\r\n    } catch {\r\n      // error is non-fatal, server will enforce real state\r\n    }\r\n  };\r\n\r\n  const handleDeleteForAll = async (msg: ChatMessage) => {\r\n    if (!msg.id) return;\r\n    const idStr = String(msg.id);\r\n\r\n    // optimistic local update â€“ keep a placeholder\r\n    setMessages((prev) =>\r\n      prev.map((m) =>\r\n        String(m.id) === idStr\r\n          ? {\r\n              ...m,\r\n              content: \"This message was deleted\",\r\n              metadata: {\r\n                ...m.metadata,\r\n                deletedForEveryone: true,\r\n              },\r\n            }\r\n          : m\r\n      )\r\n    );\r\n\r\n    // best-effort: call backend DELETE /api/chats/[chatId]\r\n    try {\r\n      await fetch(\r\n        `/api/chats/${encodeURIComponent(chatId)}`,\r\n        {\r\n          method: \"DELETE\",\r\n          credentials: \"same-origin\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n          },\r\n          body: JSON.stringify({ messageId: idStr }),\r\n        }\r\n      ).catch(() => {});\r\n    } catch {\r\n      // ignore; server is source of truth\r\n    }\r\n  };\r\n\r\n  const handleDeleteForMe = (msg: ChatMessage) => {\r\n    const idStr = String(msg.id ?? msg.__localId ?? \"\");\r\n    if (!idStr) return;\r\n    setHiddenForClient((prev) => ({\r\n      ...prev,\r\n      [idStr]: true,\r\n    }));\r\n  };\r\n\r\n  /* ------------------------\r\n     UI pieces\r\n     ------------------------ */\r\n  const headerName = deriveChatDisplayName(\r\n    info,\r\n    currentUser ?? null\r\n  );\r\n  const typingCount = Object.keys(typingUsers).length;\r\n\r\n  const Avatar = () => (\r\n    <div className=\"w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center font-medium text-slate-700\">\r\n      {(headerName && headerName[0]) || \"U\"}\r\n    </div>\r\n  );\r\n\r\n  const MessageRow = ({ msg }: { msg: ChatMessage }) => {\r\n    const msgKey = String(msg.id ?? msg.__localId ?? \"\");\r\n    if (hiddenForClient[msgKey]) return null;\r\n\r\n    const isMine =\r\n      currentUser &&\r\n      msg.sender &&\r\n      String(msg.sender?.id) ===\r\n        String(currentUser.id);\r\n    const isLocalOptimistic =\r\n      typeof msg.id === \"string\" &&\r\n      msg.id.startsWith(\"local-\");\r\n\r\n    const ts = msg.createdAt\r\n      ? new Date(msg.createdAt).toLocaleString()\r\n      : \"\";\r\n\r\n    const createdDate = msg.createdAt\r\n      ? new Date(msg.createdAt)\r\n      : null;\r\n    const msSince =\r\n      createdDate && !Number.isNaN(createdDate.getTime())\r\n        ? Date.now() - createdDate.getTime()\r\n        : Number.POSITIVE_INFINITY;\r\n\r\n    const withinEditWindow =\r\n      msSince <= 15 * 60 * 1000; // 15 minutes\r\n\r\n    const isEditing =\r\n      editingMessageId &&\r\n      String(editingMessageId) ===\r\n        String(msg.id);\r\n\r\n    const isDeletedForEveryone =\r\n      !!msg.metadata?.deletedForEveryone ||\r\n      !!msg.metadata?.deletedForAll;\r\n\r\n    const displayContent =\r\n      isDeletedForEveryone && !isEditing\r\n        ? \"This message was deleted\"\r\n        : msg.content;\r\n\r\n    return (\r\n      <div\r\n        className={`flex gap-3 ${\r\n          isMine ? \"justify-end\" : \"justify-start\"\r\n        }`}\r\n      >\r\n        {!isMine && (\r\n          <div className=\"w-9 h-9 rounded-full bg-slate-200 flex items-center justify-center text-sm shrink-0\">\r\n            {msg.sender?.name\r\n              ? msg.sender.name[0]\r\n              : \"U\"}\r\n          </div>\r\n        )}\r\n        <div\r\n          className={`max-w-[78%] p-3 rounded-xl break-words ${\r\n            isMine\r\n              ? \"bg-blue-600 text-white\"\r\n              : \"bg-slate-100 text-slate-800\"\r\n          } ${isLocalOptimistic ? \"opacity-80\" : \"\"}`}\r\n        >\r\n          {isEditing ? (\r\n            <>\r\n              <textarea\r\n                className=\"w-full text-sm rounded-md border border-slate-200 bg-white/90 text-slate-900 p-1 mb-2\"\r\n                rows={2}\r\n                value={editingDraft}\r\n                onChange={(e) =>\r\n                  setEditingDraft(e.target.value)\r\n                }\r\n              />\r\n              <div className=\"flex justify-end gap-2 text-[11px]\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() =>\r\n                    handleConfirmEdit(\r\n                      msg,\r\n                      editingDraft\r\n                    )\r\n                  }\r\n                  className=\"px-2 py-0.5 rounded-md bg-emerald-500 text-white\"\r\n                >\r\n                  Save\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleCancelEdit}\r\n                  className=\"px-2 py-0.5 rounded-md bg-slate-200 text-slate-700\"\r\n                >\r\n                  Cancel\r\n                </button>\r\n              </div>\r\n            </>\r\n          ) : (\r\n            <>\r\n              <div className=\"text-sm whitespace-pre-wrap\">\r\n                {displayContent}\r\n              </div>\r\n              {msg.attachments?.length ? (\r\n                <div className=\"mt-2 space-y-1\">\r\n                  {msg.attachments.map((a, i) => (\r\n                    <a\r\n                      key={i}\r\n                      href={a.url}\r\n                      target=\"_blank\"\r\n                      rel=\"noreferrer\"\r\n                      className=\"text-xs underline block\"\r\n                    >\r\n                      {a.name ?? a.url}\r\n                    </a>\r\n                  ))}\r\n                </div>\r\n              ) : null}\r\n            </>\r\n          )}\r\n\r\n          <div className=\"mt-1 flex items-center justify-between gap-2 text-[10px] text-slate-300\">\r\n            <span className=\"text-left\">\r\n              {ts}{\" \"}\r\n              {isLocalOptimistic ? \" â€¢ sendingâ€¦\" : \"\"}\r\n              {msg.metadata?.edited &&\r\n              !isEditing &&\r\n              !isDeletedForEveryone\r\n                ? \" â€¢ edited\"\r\n                : \"\"}\r\n            </span>\r\n            {isMine && !isDeletedForEveryone && (\r\n              <div className=\"flex items-center gap-2\">\r\n                {withinEditWindow && !isEditing && (\r\n                  <>\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() =>\r\n                        handleStartEdit(msg)\r\n                      }\r\n                      className=\"underline decoration-dotted\"\r\n                    >\r\n                      Edit\r\n                    </button>\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() =>\r\n                        handleDeleteForAll(msg)\r\n                      }\r\n                      className=\"underline decoration-dotted\"\r\n                    >\r\n                      Delete\r\n                    </button>\r\n                  </>\r\n                )}\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() =>\r\n                    handleDeleteForMe(msg)\r\n                  }\r\n                  className=\"underline decoration-dotted\"\r\n                >\r\n                  Delete for me\r\n                </button>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n        {isMine && (\r\n          <div className=\"w-9 h-9 rounded-full bg-transparent shrink-0\" />\r\n        )}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex flex-col h-full min-h-[200px]\">\r\n      <div className=\"px-3 py-2 border-b flex items-center gap-3\">\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => {\r\n            try {\r\n              window.history.back();\r\n            } catch {}\r\n          }}\r\n          className=\"p-1 rounded-md hover:bg-slate-100\"\r\n          aria-label=\"Back\"\r\n        >\r\n          â†\r\n        </button>\r\n        <Avatar />\r\n        <div className=\"flex-1 min-w-0\">\r\n          <div className=\"text-sm font-semibold truncate\">\r\n            {headerName}\r\n          </div>\r\n          <div className=\"text-xs text-slate-400\">\r\n            {typingCount > 0\r\n              ? typingCount > 1\r\n                ? `${typingCount} people typingâ€¦`\r\n                : \"typingâ€¦\"\r\n              : info?.type &&\r\n                info.type\r\n                  .toString()\r\n                  .toLowerCase()\r\n                  .includes(\"team\")\r\n              ? \"Group\"\r\n              : \"Direct\"}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div\r\n        ref={listRef}\r\n        className=\"flex-1 overflow-auto p-4 space-y-3 bg-white\"\r\n      >\r\n        {loading ? (\r\n          <div className=\"text-sm text-slate-500\">\r\n            Loading messagesâ€¦\r\n          </div>\r\n        ) : messages.length === 0 ? (\r\n          <div className=\"text-sm text-slate-500\">\r\n            No messages yet.\r\n          </div>\r\n        ) : (\r\n          messages.map((m) => {\r\n            const key =\r\n              m.id ?? m.__localId ?? genLocalId(\"k-\");\r\n            return (\r\n              <MessageRow key={String(key)} msg={m} />\r\n            );\r\n          })\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"p-3 border-t bg-white\">\r\n        <ComposeBox\r\n          chatId={chatId}\r\n          onSent={handleOutgoing}\r\n          onTyping={() => {\r\n            try {\r\n              const payload = {\r\n                chatId,\r\n                user: currentUser?.id ?? null,\r\n              };\r\n              if (\r\n                chatSocket &&\r\n                typeof chatSocket.emit === \"function\"\r\n              ) {\r\n                chatSocket.emit(\"typing\", payload);\r\n              } else if (\r\n                socketClient &&\r\n                typeof socketClient.emit === \"function\"\r\n              ) {\r\n                socketClient.emit(\"typing\", payload);\r\n              }\r\n            } catch {}\r\n          }}\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":["React","useCallback","useEffect","useRef","useState","socketClient","ComposeBox","Message","OutgoingMessage","useChatSocket","MinimalUser","id","name","email","role","ChatMessage","chatId","content","metadata","externalId","createdAt","sender","attachments","Array","url","__localId","ChatInfo","type","participants","meta","genLocalId","prefix","Math","random","toString","slice","deriveChatDisplayName","info","me","t","toLowerCase","serverName","teamName","isGenericServerName","trim","startsWith","members","length","other","find","p","String","lastSender","lastMessage","senderName","TeamChat","currentUser","messages","setMessages","setInfo","loading","setLoading","typingUsers","setTypingUsers","Record","listRef","HTMLDivElement","editingMessageId","setEditingMessageId","editingDraft","setEditingDraft","hiddenForClient","setHiddenForClient","chatSocket","seenIdsRef","Set","localToServerIdRef","isNearBottomRef","mountedRef","markRead","fetch","encodeURIComponent","method","credentials","current","controller","AbortController","load","res","signal","json","ok","catch","msgs","messages_list","items","rows","normalized","isArray","map","m","messageId","add","metaRes","metaJson","list","chats","found","c","undefined","chatInfo","prev","users","err","console","warn","joinChat","emit","abort","leaveChat","on","handleMessage","payload","incomingChatId","room","message","chat","msg","serverId","text","from","user","ts","created_at","Date","toISOString","has","optimisticIdx","findIndex","copy","oldLocalId","newMsg","userId","fullName","files","delete","idToUse","appended","existing","existingIds","senderId","added","e","handleTyping","whichChat","window","setTimeout","handleMessageUpdated","action","base","isDeletedForAll","deletedForEveryone","deletedForAll","edited","off","el","onScroll","remaining","scrollHeight","scrollTop","clientHeight","addEventListener","removeEventListener","requestAnimationFrame","scrollTo","top","behavior","handleOutgoing","isLocal","localMsg","localKey","Object","keys","lk","idx","optIdx","handleStartEdit","handleCancelEdit","handleConfirmEdit","newContent","idStr","trimmed","headers","body","JSON","stringify","handleDeleteForAll","handleDeleteForMe","headerName","typingCount","Avatar","MessageRow","msgKey","isMine","isLocalOptimistic","toLocaleString","createdDate","msSince","Number","isNaN","getTime","now","POSITIVE_INFINITY","withinEditWindow","isEditing","isDeletedForEveryone","displayContent","target","value","a","i","history","back","includes","key"],"mappings":"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","ignoreList":[],"debugId":null}}]
}