{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/app/api/countries/route.ts"],"sourcesContent":["// src/app/api/countries/route.ts\r\nimport { NextResponse } from \"next/server\";\r\n\r\n/**\r\n * GET /api/countries\r\n *\r\n * - Primary: fetches minimal country data from restcountries.com\r\n * - Fallback: uses a built-in safe list if upstream fails or returns invalid data\r\n * - Normalizes, deduplicates (by country code) and sorts results\r\n * - Returns { ok: boolean, countries: Array<{ code, name, region, languages }> }\r\n * - Sets CDN-friendly cache headers (s-maxage), configurable via COUNTRIES_S_MAXAGE\r\n *\r\n * Env:\r\n * - COUNTRIES_TIMEOUT_MS (optional) default: 5000\r\n * - COUNTRIES_S_MAXAGE (optional) default: 3600 (1 hour)\r\n */\r\n\r\nconst FIELDS = \"name,cca2,region,languages\";\r\nconst UPSTREAM_URL = `https://restcountries.com/v3.1/all?fields=${FIELDS}`;\r\n\r\nconst TIMEOUT_MS = Number(process.env.COUNTRIES_TIMEOUT_MS ?? 5000);\r\nconst S_MAXAGE = Number(process.env.COUNTRIES_S_MAXAGE ?? 3600);\r\n\r\nconst FALLBACK_COUNTRIES = [\r\n  { code: \"IN\", name: \"India\", region: \"Asia\", languages: { hin: \"Hindi\", eng: \"English\" } },\r\n  { code: \"US\", name: \"United States\", region: \"Americas\", languages: { eng: \"English\" } },\r\n  { code: \"GB\", name: \"United Kingdom\", region: \"Europe\", languages: { eng: \"English\" } },\r\n  { code: \"CA\", name: \"Canada\", region: \"Americas\", languages: { eng: \"English\", fra: \"French\" } },\r\n  { code: \"AU\", name: \"Australia\", region: \"Oceania\", languages: { eng: \"English\" } },\r\n  { code: \"DE\", name: \"Germany\", region: \"Europe\", languages: { deu: \"German\" } },\r\n  { code: \"FR\", name: \"France\", region: \"Europe\", languages: { fra: \"French\" } },\r\n  { code: \"SG\", name: \"Singapore\", region: \"Asia\", languages: { eng: \"English\", zho: \"Chinese\" } },\r\n];\r\n\r\n/** Fetch helper with timeout using AbortController. */\r\nasync function fetchWithTimeout(url: string, timeoutMs = TIMEOUT_MS, init?: RequestInit) {\r\n  const controller = new AbortController();\r\n  const signal = controller.signal;\r\n  const t = setTimeout(() => controller.abort(), timeoutMs);\r\n\r\n  try {\r\n    const res = await fetch(url, { signal, ...init });\r\n    clearTimeout(t);\r\n    return res;\r\n  } catch (err) {\r\n    clearTimeout(t);\r\n    throw err;\r\n  }\r\n}\r\n\r\n/** Normalize a raw upstream country object into our minimal shape, or null if invalid. */\r\nfunction normalizeCountry(raw: any) {\r\n  if (!raw || typeof raw !== \"object\") return null;\r\n\r\n  // prefer cca2 (2-letter), but accept cca3 if present\r\n  const codeRaw = raw?.cca2 ?? raw?.cca3 ?? \"\";\r\n  const code = String(codeRaw).trim().toUpperCase();\r\n  if (!code || (code.length !== 2 && code.length !== 3)) return null;\r\n\r\n  // name: prefer name.common -> name.official -> fallback to code\r\n  let name = \"\";\r\n  try {\r\n    if (raw?.name?.common) name = String(raw.name.common);\r\n    else if (raw?.name?.official) name = String(raw.name.official);\r\n    else if (typeof raw.name === \"string\") name = raw.name;\r\n    else name = code;\r\n  } catch {\r\n    name = code;\r\n  }\r\n\r\n  const region = raw?.region ?? null;\r\n\r\n  // languages: ensure mapping of string values if present\r\n  const languages: Record<string, string> = {};\r\n  if (raw.languages && typeof raw.languages === \"object\") {\r\n    for (const [k, v] of Object.entries(raw.languages)) {\r\n      try {\r\n        languages[k] = typeof v === \"string\" ? v : String(v);\r\n      } catch {\r\n        // skip bad values\r\n      }\r\n    }\r\n  }\r\n\r\n  return { code, name, region, languages };\r\n}\r\n\r\n/** Deduplicate by code (case-insensitive) and sort by name. */\r\nfunction dedupeAndSort(list: Array<{ code: string; name: string; region?: string | null; languages?: any }>) {\r\n  const map = new Map<string, { code: string; name: string; region?: string | null; languages?: any }>();\r\n  for (const item of list) {\r\n    if (!item || !item.code) continue;\r\n    const key = item.code.toUpperCase();\r\n    if (!map.has(key)) map.set(key, item);\r\n  }\r\n\r\n  const arr = Array.from(map.values());\r\n  try {\r\n    arr.sort((a, b) => (a.name ?? \"\").localeCompare(b.name ?? \"\", undefined, { sensitivity: \"base\" }));\r\n  } catch {\r\n    arr.sort((a, b) => String(a.name).localeCompare(String(b.name)));\r\n  }\r\n  return arr;\r\n}\r\n\r\nexport async function GET() {\r\n  try {\r\n    // Try fetching upstream with timeout\r\n    let upstreamJson: any = null;\r\n    try {\r\n      const res = await fetchWithTimeout(UPSTREAM_URL, TIMEOUT_MS, { method: \"GET\" });\r\n      if (!res.ok) {\r\n        console.warn(\"api/countries upstream non-ok:\", res.status);\r\n        throw new Error(`Upstream returned ${res.status}`);\r\n      }\r\n      try {\r\n        upstreamJson = await res.json();\r\n      } catch (jsonErr) {\r\n        console.warn(\"api/countries: failed to parse upstream JSON:\", (jsonErr as any)?.message ?? jsonErr);\r\n        upstreamJson = null;\r\n      }\r\n    } catch (fetchErr) {\r\n      console.warn(\"api/countries upstream fetch failed:\", (fetchErr as any)?.message ?? fetchErr);\r\n      upstreamJson = null;\r\n    }\r\n\r\n    // Transform upstream or fallback\r\n    let countries: Array<{ code: string; name: string; region?: string | null; languages?: any }>;\r\n    if (Array.isArray(upstreamJson) && upstreamJson.length > 0) {\r\n      const normalized = upstreamJson.map(normalizeCountry).filter((c): c is { code: string; name: string; region?: string | null; languages?: any } => Boolean(c));\r\n      countries = dedupeAndSort(normalized);\r\n      if (!countries || countries.length === 0) {\r\n        countries = FALLBACK_COUNTRIES;\r\n      }\r\n    } else {\r\n      countries = FALLBACK_COUNTRIES;\r\n    }\r\n\r\n    const headers = {\r\n      \"Cache-Control\": `public, s-maxage=${S_MAXAGE}, stale-while-revalidate=60`,\r\n      \"Content-Type\": \"application/json; charset=utf-8\",\r\n    };\r\n\r\n    return NextResponse.json({ ok: true, countries }, { status: 200, headers });\r\n  } catch (err: any) {\r\n    console.error(\"api/countries fatal error:\", err);\r\n    const headers = {\r\n      \"Cache-Control\": `public, s-maxage=${S_MAXAGE}, stale-while-revalidate=60`,\r\n      \"Content-Type\": \"application/json; charset=utf-8\",\r\n    };\r\n    // Always return a non-empty array so clients don't crash\r\n    return NextResponse.json(\r\n      { ok: false, countries: FALLBACK_COUNTRIES, error: (err && (err.message ?? String(err))) || \"internal_error\" },\r\n      { status: 500, headers }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}