{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/app/api/auth/phone/send/route.ts"],"sourcesContent":["// File: src/app/api/auth/phone/send/route.ts\r\nimport { NextResponse } from \"next/server\";\r\n\r\n/**\r\n * POST /api/auth/phone/send\r\n *\r\n * Body: { phone: string, tempToken?: string, resend?: boolean }\r\n *\r\n * Behavior:\r\n * - Defensively parse raw body and return 400 on malformed JSON (echo raw for debugging).\r\n * - Validate phone (basic E.164-like check).\r\n * - Try to use user's createPhoneOtp(phone) helper from \"@/lib/otp\" (if present).\r\n *   - If helper missing or fails, generate a 6-digit OTP locally (dev fallback).\r\n * - If Twilio env vars present, send SMS via Twilio (dynamic import).\r\n * - If Twilio not configured, log OTP to server console (dev-friendly).\r\n * - Return structured JSON with helpful fields and non-opaque errors.\r\n */\r\n\r\n/* ------------------------- Helpers ------------------------- */\r\n\r\nfunction routeLog(...args: any[]) {\r\n  // centralize route logs so it's easy to grep in dev logs\r\n  console.error(\"[/api/auth/phone/send]\", ...args);\r\n}\r\n\r\nfunction isValidPhone(value: any) {\r\n  if (!value || typeof value !== \"string\") return false;\r\n  const v = value.trim();\r\n  // allow optional leading + and 7-20 digits (basic, prevents obvious bad data)\r\n  return /^\\+?[0-9]{7,20}$/.test(v);\r\n}\r\n\r\ntype CreatePhoneOtpResult = { id?: string | null; code: string };\r\n\r\n/**\r\n * Try to call user-provided createPhoneOtp helper.\r\n * If helper not present or fails, return a generated OTP (dev fallback).\r\n */\r\nasync function createOrGenerateOtp(phone: string): Promise<CreatePhoneOtpResult> {\r\n  try {\r\n    // dynamic import so route remains resilient if helper is absent or path differs\r\n    const otpModule = await import(\"@/lib/otp\").catch(() => null);\r\n    if (otpModule && typeof otpModule.createPhoneOtp === \"function\") {\r\n      try {\r\n        const res = await otpModule.createPhoneOtp(phone);\r\n        // normalize return shape: accept { id, code } or { id, otp } or { otp }\r\n        const id = res?.id ?? null;\r\n        const code = String(res?.code ?? res?.otp ?? \"\");\r\n        if (!code) {\r\n          routeLog(\"createPhoneOtp returned invalid shape; falling back to generated code\", { returned: res });\r\n        } else {\r\n          return { id, code };\r\n        }\r\n      } catch (callErr: any) {\r\n        routeLog(\"createPhoneOtp call threw; falling back to generated OTP:\", callErr?.message ?? callErr);\r\n      }\r\n    } else {\r\n      routeLog(\"createPhoneOtp helper not found at '@/lib/otp' — using fallback OTP\");\r\n    }\r\n  } catch (impErr: any) {\r\n    // any import failure -> fallback\r\n    routeLog(\"Error importing '@/lib/otp' (ignored):\", impErr?.message ?? impErr);\r\n  }\r\n\r\n  // fallback: generate a 6-digit OTP (dev-friendly)\r\n  const generated = String(Math.floor(100000 + Math.random() * 900000));\r\n  return { id: null, code: generated };\r\n}\r\n\r\n/* ------------------------- Route Handler ------------------------- */\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    // Read raw text body (defensive — avoids throwing on malformed JSON)\r\n    const rawText = await req.text().catch(() => \"\");\r\n    if (!rawText || rawText.trim().length === 0) {\r\n      return NextResponse.json({ ok: false, error: \"empty_body\", message: \"Request body is empty\" }, { status: 400 });\r\n    }\r\n\r\n    // Attempt to parse JSON — return 400 with raw body if parse fails\r\n    let body: any;\r\n    try {\r\n      body = JSON.parse(rawText);\r\n    } catch (parseErr: any) {\r\n      routeLog(\"Malformed JSON received:\", parseErr?.message ?? parseErr, \"raw:\", rawText.slice(0, 1000));\r\n      return NextResponse.json(\r\n        { ok: false, error: \"malformed_json\", message: parseErr?.message ?? \"Invalid JSON\", raw: rawText },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const phone = (body?.phone ?? \"\").toString().trim();\r\n    const tempToken = body?.tempToken ?? null;\r\n    const resend = Boolean(body?.resend);\r\n\r\n    // Validate phone shape\r\n    if (!isValidPhone(phone)) {\r\n      return NextResponse.json(\r\n        {\r\n          ok: false,\r\n          error: \"invalid_phone\",\r\n          message: \"phone is required and must be E.164-like (e.g. +919876543210)\",\r\n          received: phone,\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Optional: verify tempToken if you want to enforce email verification earlier in the flow\r\n    if (tempToken) {\r\n      try {\r\n        const jwtMod = await import(\"@/lib/jwt\").catch(() => null);\r\n        if (jwtMod && typeof jwtMod.verifyTemp === \"function\") {\r\n          try {\r\n            const decoded = jwtMod.verifyTemp(tempToken);\r\n            if (decoded?.phone && decoded.phone !== phone) {\r\n              // Log mismatch — policy choice whether to fail, here we only warn\r\n              routeLog(\"Warning: tempToken phone mismatch\", { decodedPhone: decoded.phone, requestPhone: phone });\r\n            }\r\n          } catch (vErr: any) {\r\n            routeLog(\"verifyTemp failed:\", vErr?.message ?? vErr);\r\n            return NextResponse.json({ ok: false, error: \"invalid_temp_token\" }, { status: 401 });\r\n          }\r\n        }\r\n      } catch (e) {\r\n        // ignore absence of jwt helper\r\n      }\r\n    }\r\n\r\n    // Create OTP (use helper if available, else generate)\r\n    const { id, code } = await createOrGenerateOtp(phone);\r\n\r\n    // Build message text\r\n    const messageText = `Your SignalHub verification code is ${code}. It expires in 10 minutes.`;\r\n\r\n    // Twilio config (support different env names)\r\n    const TW_SID = process.env.TWILIO_ACCOUNT_SID || process.env.TWILIO_SID;\r\n    const TW_TOKEN = process.env.TWILIO_AUTH_TOKEN || process.env.TWILIO_TOKEN;\r\n    const TW_FROM = process.env.TWILIO_PHONE_NUMBER || process.env.TWILIO_FROM;\r\n\r\n    let sid: string | null = null;\r\n    let status: string | null = null;\r\n    let devOtpLogged = false;\r\n\r\n    if (TW_SID && TW_TOKEN && TW_FROM) {\r\n      // Try to dynamically import Twilio and send SMS\r\n      try {\r\n        const Twilio = (await import(\"twilio\")).default;\r\n        const client = Twilio(TW_SID, TW_TOKEN);\r\n        const msg = await client.messages.create({ to: phone, from: TW_FROM, body: messageText });\r\n        sid = msg?.sid ?? null;\r\n        status = msg?.status ?? null;\r\n        routeLog(\"Twilio message created\", { sid, status, to: phone });\r\n      } catch (twErr: any) {\r\n        routeLog(\"Twilio send failed:\", twErr?.message ?? twErr);\r\n        return NextResponse.json({ ok: false, error: \"sms_send_failed\", details: twErr?.message ?? String(twErr) }, { status: 500 });\r\n      }\r\n    } else {\r\n      // Twilio not configured — dev fallback: log OTP to server console\r\n      devOtpLogged = true;\r\n      routeLog(\"Twilio not configured — dev OTP logged\", { phone, id: id ?? null, code, messageText });\r\n    }\r\n\r\n    // Successful response\r\n    return NextResponse.json(\r\n      { ok: true, id: id ?? null, sid, status: status ?? (sid ? \"queued\" : \"mocked\"), devOtpLogged },\r\n      { status: 200 }\r\n    );\r\n  } catch (err: any) {\r\n    // Unexpected error — return helpful JSON and log stack\r\n    routeLog(\"Unexpected handler error:\", err?.message ?? err, err?.stack ?? \"\");\r\n    return NextResponse.json({ ok: false, error: \"internal_server_error\", details: err?.message ?? String(err) }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}