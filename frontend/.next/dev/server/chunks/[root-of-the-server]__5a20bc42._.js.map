{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  // prevent multiple instantiation in dev\r\n  // eslint-disable-next-line no-var\r\n  var prisma: PrismaClient | undefined;\r\n}\r\n\r\nexport const prisma =\r\n  global.prisma ??\r\n  new PrismaClient({\r\n    log: [\"query\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") global.prisma = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;AAQO,MAAM,SACX,OAAO,MAAM,IACb,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,OAAO,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 68, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/app/api/phone/verify-otp/route.ts"],"sourcesContent":["// app/api/phone/verify-otp/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { Prisma } from \"@prisma/client\";\r\n\r\nfunction safeStringify(v: any) {\r\n  try { return JSON.stringify(v); } catch { return String(v); }\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json().catch(() => ({}));\r\n    const phone: string | undefined = body?.phone;\r\n    const otp: string | undefined = body?.otp;\r\n\r\n    if (!phone || !otp) {\r\n      console.warn(\"[verify-otp] missing phone or otp\", { phone, otp });\r\n      return NextResponse.json({ error: \"Phone and OTP are required\" }, { status: 400 });\r\n    }\r\n\r\n    // Find the most recent unused OTP record for this phone\r\n    const record = await prisma.phoneOtp.findFirst({\r\n      where: { phone, used: false },\r\n      orderBy: { createdAt: \"desc\" },\r\n    });\r\n\r\n    if (!record) {\r\n      console.warn(\"[verify-otp] no otp record found for phone\", phone);\r\n      return NextResponse.json({ error: \"No OTP found for this phone\" }, { status: 404 });\r\n    }\r\n\r\n    // Check expiry (5 minutes)\r\n    const now = new Date();\r\n    const createdAt = new Date(record.createdAt);\r\n    const diffMins = (now.getTime() - createdAt.getTime()) / 60000;\r\n    if (diffMins > 5) {\r\n      console.warn(\"[verify-otp] otp expired\", { phone, createdAt, diffMins });\r\n      return NextResponse.json({ error: \"OTP expired. Please request a new one.\" }, { status: 400 });\r\n    }\r\n\r\n    // Attempt limit\r\n    if (record.attempts >= 5) {\r\n      console.warn(\"[verify-otp] too many attempts\", { phone, attempts: record.attempts });\r\n      return NextResponse.json({ error: \"Too many attempts. Request new OTP.\" }, { status: 429 });\r\n    }\r\n\r\n    // Wrong OTP -> increment attempts and return error\r\n    if (record.otp !== otp) {\r\n      await prisma.phoneOtp.update({\r\n        where: { id: record.id },\r\n        data: { attempts: record.attempts + 1 },\r\n      });\r\n      console.warn(\"[verify-otp] invalid otp attempt\", { phone, attempts: record.attempts + 1 });\r\n      return NextResponse.json({ error: \"Invalid OTP\" }, { status: 400 });\r\n    }\r\n\r\n    // Mark OTP used\r\n    await prisma.phoneOtp.update({\r\n      where: { id: record.id },\r\n      data: { used: true },\r\n    });\r\n\r\n    // Try to find the User via profile.phoneNumber (preferred). This might throw if schema doesn't have phoneNumber.\r\n    let matchedUser: any = null;\r\n    try {\r\n      matchedUser = await prisma.user.findFirst({\r\n        where: {\r\n          profile: {\r\n            is: {\r\n              phoneNumber: phone, // <-- works only if profile.phoneNumber exists in schema\r\n            },\r\n          },\r\n        },\r\n        select: { id: true, email: true, name: true, profile: true, role: true },\r\n      });\r\n    } catch (err) {\r\n      // If this is a Prisma validation error because phoneNumber doesn't exist, fallback below\r\n      if (err instanceof Prisma.PrismaClientValidationError || (err && (err as any).message && (err as any).message.includes(\"Unknown argument\"))) {\r\n        console.info(\"[verify-otp] profile.phoneNumber filter not available in schema, falling back to metadata/string-scan lookup\");\r\n        matchedUser = null;\r\n      } else {\r\n        // unexpected error — rethrow\r\n        console.error(\"[verify-otp] unexpected error during user lookup:\", err);\r\n        throw err;\r\n      }\r\n    }\r\n\r\n    // Fallback: if matchedUser is still null, attempt to find profile by inspecting stored profile fields.\r\n    // This fallback reads a small set of candidate profiles (by phone contained in metadata or similar).\r\n    if (!matchedUser) {\r\n      // Try to find a profile row where metadata JSON or text fields contain the phone string.\r\n      // We'll fetch recent profiles (safeguard) and check JS-side for phone string in candidate fields.\r\n      // NOTE: adjust `take` if you expect many users (this is a heuristic fallback).\r\n      const candidates = await prisma.profile.findMany({\r\n        orderBy: { updatedAt: \"desc\" },\r\n        take: 200, // limit scan size — increase if needed\r\n        select: { id: true, userId: true, displayName: true, avatarUrl: true, bio: true, metadata: true, createdAt: true, updatedAt: true },\r\n      });\r\n\r\n      const phoneNormalized = String(phone).replace(/\\s|-/g, \"\");\r\n\r\n      const found = candidates.find((p) => {\r\n        // check common fields and metadata\r\n        try {\r\n          if (p.metadata) {\r\n            const metaStr = safeStringify(p.metadata);\r\n            if (metaStr.includes(phone) || metaStr.includes(phoneNormalized)) return true;\r\n          }\r\n        } catch {}\r\n        if (p.displayName && String(p.displayName).includes(phone)) return true;\r\n        if (p.bio && String(p.bio).includes(phone)) return true;\r\n        return false;\r\n      });\r\n\r\n      if (found) {\r\n        matchedUser = await prisma.user.findUnique({\r\n          where: { id: found.userId },\r\n          select: { id: true, email: true, name: true, profile: true, role: true },\r\n        });\r\n        console.info(\"[verify-otp] matched user by scanning profiles\", { phone, profileId: found.id, userId: found.userId });\r\n      } else {\r\n        console.warn(\"[verify-otp] fallback scan did not match any profile for phone\", phone);\r\n      }\r\n    }\r\n\r\n    if (!matchedUser) {\r\n      // No user found; return success for OTP verification but inform caller\r\n      console.warn(\"[verify-otp] otp verified but no user found for phone\", phone);\r\n      return NextResponse.json({\r\n        ok: true,\r\n        message: \"OTP verified but no user account found for this phone.\",\r\n      });\r\n    }\r\n\r\n    // Update profile: try update existing profile by userId; upsert if not exists\r\n    try {\r\n      // Prefer update by userId\r\n      await prisma.profile.upsert({\r\n        where: { userId: matchedUser.id },\r\n        create: {\r\n          userId: matchedUser.id,\r\n          // create minimal profile — adjust required fields accordingly\r\n          phoneNumber: phone as any, // if your schema doesn't have phoneNumber, this will throw; wrapped below\r\n          phoneVerified: true as any,\r\n          phoneVerifiedAt: new Date(),\r\n        } as any,\r\n        update: {\r\n          // set canonical phone + verified flags\r\n          // if your schema doesn't have these fields, this may throw — catch below\r\n          phoneNumber: phone as any,\r\n          phoneVerified: true as any,\r\n          phoneVerifiedAt: new Date(),\r\n        } as any,\r\n      });\r\n    } catch (err) {\r\n      // If upsert fails because schema doesn't have phoneNumber/phoneVerified fields,\r\n      // attempt to store verification inside metadata JSON (non-ideal but safe).\r\n      console.warn(\"[verify-otp] upsert to profile with phone fields failed — falling back to metadata patch\", err);\r\n\r\n      try {\r\n        // load current profile\r\n        const existing = await prisma.profile.findUnique({ where: { userId: matchedUser.id }, select: { id: true, metadata: true } });\r\n        const newMeta = { ...(existing?.metadata ?? {} as any) };\r\n        newMeta.phoneVerified = true;\r\n        newMeta.phoneVerifiedAt = new Date().toISOString();\r\n        newMeta.phone = phone;\r\n\r\n        if (existing) {\r\n          await prisma.profile.update({\r\n            where: { userId: matchedUser.id },\r\n            data: { metadata: newMeta as any },\r\n          });\r\n        } else {\r\n          // if profile doesn't exist, create one with metadata\r\n          await prisma.profile.create({\r\n            data: {\r\n              userId: matchedUser.id,\r\n              metadata: newMeta as any,\r\n            } as any,\r\n          });\r\n        }\r\n      } catch (metaErr) {\r\n        console.error(\"[verify-otp] fallback metadata update failed:\", metaErr);\r\n        return NextResponse.json({ error: \"Failed to update profile after verifying OTP\" }, { status: 500 });\r\n      }\r\n    }\r\n\r\n    // Return updated user (fresh)\r\n    const updatedUser = await prisma.user.findUnique({\r\n      where: { id: matchedUser.id },\r\n      select: { id: true, email: true, name: true, role: true, profile: true, updatedAt: true },\r\n    });\r\n\r\n    console.info(\"[verify-otp] phone verified and profile updated for user\", matchedUser.id);\r\n    return NextResponse.json({ ok: true, message: \"Phone verified successfully\", user: updatedUser });\r\n  } catch (error) {\r\n    console.error(\"Error verifying OTP:\", error);\r\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}