{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 136, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/app/api/invites/creates/route.ts"],"sourcesContent":["// src/app/api/invites/creates/route.ts\r\nimport path from \"path\";\r\nimport fs from \"fs\";\r\nimport { NextResponse } from \"next/server\";\r\nimport crypto from \"crypto\";\r\nimport nodemailer from \"nodemailer\";\r\nimport dotenv from \"dotenv\";\r\n\r\n/**\r\n * DEV NOTE:\r\n * - This file explicitly loads dotenv from the project root so the route can pick up .env during development.\r\n * - In many setups Next loads env automatically on boot; explicit loading is a safe fallback for dev.\r\n * - Remove or keep depending on your environment strategy.\r\n */\r\n\r\n// load .env from project root if present (dev fallback)\r\nconst envPath = path.join(process.cwd(), \".env\");\r\nif (fs.existsSync(envPath)) {\r\n  dotenv.config({ path: envPath });\r\n  console.log(\"[invites/creates] Loaded .env from\", envPath);\r\n} else {\r\n  console.log(\"[invites/creates] .env not found at\", envPath, \" — relying on process.env\");\r\n}\r\n\r\nfunction isValidEmail(email: string) {\r\n  return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email);\r\n}\r\n\r\n/**\r\n * Helper to create a transporter with sensible defaults.\r\n * Uses SMTP_* env vars (SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_FROM).\r\n * Keeps logs minimal and never prints secrets.\r\n */\r\nfunction createTransporter() {\r\n  // read SMTP env vars; keep names consistent with what you showed me\r\n  const host = process.env.SMTP_HOST || \"127.0.0.1\";\r\n  const port = Number(process.env.SMTP_PORT || 25);\r\n  // determine secure: true for port 465 or when explicitly set\r\n  const secure = process.env.SMTP_SECURE === \"true\" || port === 465;\r\n  const user = process.env.SMTP_USER || \"\";\r\n  const pass = process.env.SMTP_PASS || \"\";\r\n\r\n  // tls reject config: allow overriding in dev for self-signed certs\r\n  const rejectUnauthorized = process.env.SMTP_TLS_REJECT !== \"false\";\r\n\r\n  console.log(\"[invites/creates] SMTP config:\", {\r\n    host,\r\n    port,\r\n    secure,\r\n    authProvided: !!user,\r\n  });\r\n\r\n  const transporter = nodemailer.createTransport({\r\n    host,\r\n    port,\r\n    secure,\r\n    auth: user ? { user, pass } : undefined,\r\n    // For STARTTLS (port 587) nodemailer will upgrade automatically when secure === false\r\n    tls: {\r\n      rejectUnauthorized,\r\n    },\r\n  });\r\n\r\n  return transporter;\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    // parse body\r\n    const body = await req.json().catch(() => ({}));\r\n    const email = (body?.email || \"\").toString().trim().toLowerCase();\r\n\r\n    if (!email || !isValidEmail(email)) {\r\n      return NextResponse.json({ ok: false, message: \"Invalid email address\" }, { status: 400 });\r\n    }\r\n\r\n    // generate token + expiry\r\n    const token = crypto.randomBytes(24).toString(\"hex\");\r\n    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours\r\n\r\n    // build invite link (ensure you set NEXT_PUBLIC_APP_URL in .env)\r\n    const appUrl = process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\";\r\n    const inviteLink = `${appUrl.replace(/\\/$/, \"\")}/invite/accept?token=${token}`;\r\n\r\n    // create transporter & verify SMTP connection\r\n    const transporter = createTransporter();\r\n\r\n    try {\r\n      await transporter.verify();\r\n      console.log(\"[invites/creates] SMTP verify OK\");\r\n    } catch (verifyErr: any) {\r\n      console.error(\"[invites/creates] SMTP verify failed:\", verifyErr && (verifyErr.message || verifyErr));\r\n      return NextResponse.json(\r\n        { ok: false, message: `SMTP connection failed: ${verifyErr?.message || \"check server logs\"}` },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // (Optional) Persist invite token to DB here (see Prisma example in original file)\r\n\r\n    // prepare mail\r\n    // prefer explicit INVITE_FROM if present, otherwise fall back to SMTP_FROM, then to a safe default\r\n    const fromAddress =\r\n      process.env.INVITE_FROM || process.env.SMTP_FROM || `\"SignalHub\" <no-reply@yourdomain.com>`;\r\n\r\n    const mailOptions = {\r\n      from: fromAddress,\r\n      to: email,\r\n      subject: \"You're invited to join as a manager — SignalHub\",\r\n      html: `\r\n        <div style=\"font-family: Inter, Arial, sans-serif; color:#0f172a;\">\r\n          <h2>You're invited to join SignalHub</h2>\r\n          <p>Hello,</p>\r\n          <p>You were invited to join as a <strong>manager</strong>. Click the link below to accept the invitation and complete your account setup.</p>\r\n          <p style=\"margin: 18px 0;\">\r\n            <a href=\"${inviteLink}\" style=\"display:inline-block;padding:10px 14px;background:#0f172a;color:#fff;border-radius:8px;text-decoration:none;\">Accept invitation</a>\r\n          </p>\r\n          <p>This link will expire on <strong>${expiresAt.toUTCString()}</strong> (24 hours).</p>\r\n          <p>If you didn't request this, you can ignore this email.</p>\r\n          <hr />\r\n          <p style=\"font-size:12px;color:#6b7280\">Sent by SignalHub</p>\r\n        </div>\r\n      `,\r\n    };\r\n\r\n    // send email\r\n    try {\r\n      const info = await transporter.sendMail(mailOptions);\r\n      console.log(\r\n        \"[invites/creates] sendMail info:\",\r\n        {\r\n          messageId: info?.messageId,\r\n          accepted: Array.isArray(info?.accepted) ? info.accepted.length : info?.accepted || 0,\r\n          rejected: Array.isArray(info?.rejected) ? info.rejected.length : info?.rejected || 0,\r\n        }\r\n      );\r\n    } catch (sendErr: any) {\r\n      console.error(\"[invites/creates] sendMail error:\", sendErr);\r\n      const safeMsg = sendErr?.response || sendErr?.message || \"Failed to send email\";\r\n      return NextResponse.json({ ok: false, message: `Can't send mail: ${safeMsg}` }, { status: 500 });\r\n    }\r\n\r\n    // All good — return invite token/expiry (for debugging; remove token in production)\r\n    return NextResponse.json({\r\n      ok: true,\r\n      message: \"Invite sent\",\r\n      token,\r\n      expiresAt: expiresAt.toISOString(),\r\n    });\r\n  } catch (err: any) {\r\n    console.error(\"[invites/creates] Fatal error:\", err);\r\n    return NextResponse.json({ ok: false, message: err?.message || \"Server error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}