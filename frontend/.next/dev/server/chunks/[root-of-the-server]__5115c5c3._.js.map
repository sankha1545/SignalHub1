{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  // prevent multiple instantiation in dev\r\n  // eslint-disable-next-line no-var\r\n  var prisma: PrismaClient | undefined;\r\n}\r\n\r\nexport const prisma =\r\n  global.prisma ??\r\n  new PrismaClient({\r\n    log: [\"query\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") global.prisma = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;AAQO,MAAM,SACX,OAAO,MAAM,IACb,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,OAAO,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 158, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/lib/mail.ts"],"sourcesContent":["// src/lib/mail.ts\r\nimport nodemailer, { Transporter } from \"nodemailer\";\r\n\r\nconst host = process.env.SMTP_HOST || \"localhost\";\r\nconst port = Number(process.env.SMTP_PORT || 587);\r\nconst user = process.env.SMTP_USER || \"\";\r\nconst pass = process.env.SMTP_PASS || \"\";\r\nconst from = process.env.SMTP_FROM || (user || `no-reply@localhost`);\r\n\r\nfunction createTransporter(): Transporter {\r\n  const secure = port === 465; // implicit TLS on 465\r\n  const auth = user ? { user, pass } : undefined;\r\n\r\n  const transporter = nodemailer.createTransport({\r\n    host,\r\n    port,\r\n    secure,\r\n    auth,\r\n    // During development you can allow self-signed certs by setting rejectUnauthorized false.\r\n    // REMOVE or set to true in production.\r\n    tls: {\r\n      rejectUnauthorized: process.env.NODE_ENV === \"production\" ? true : false,\r\n    },\r\n    // Optional: increase connection timeout for slow relays\r\n    connectionTimeout: 30_000,\r\n  });\r\n\r\n  return transporter;\r\n}\r\n\r\nexport const transporter = createTransporter();\r\n\r\n/**\r\n * Verify transporter connection/auth.\r\n * Call this at startup or before sending test messages to get clear errors.\r\n */\r\nexport async function verifyTransporter() {\r\n  try {\r\n    const ok = await transporter.verify();\r\n    console.log(\"[mail] transporter verified:\", ok);\r\n    return ok;\r\n  } catch (err) {\r\n    console.error(\"[mail] transporter verification failed:\", err);\r\n    throw err;\r\n  }\r\n}\r\n\r\n/**\r\n * Send OTP email.\r\n * Throws if sending fails (so route can return 500).\r\n */\r\nexport async function sendOTPEmail(to: string, code: string) {\r\n  console.log(\"[mail] sendOTPEmail ->\", { to, host, port, user: !!user });\r\n\r\n  if (!to) throw new Error(\"Missing recipient address\");\r\n\r\n  // ensure from is a valid value\r\n  const envelopeFrom = from || (user ? user : \"no-reply@localhost\");\r\n\r\n  const html = `\r\n    <div style=\"font-family: sans-serif; line-height: 1.5;\">\r\n      <h2>Your OTP Code</h2>\r\n      <p>Use the following 6-digit code to complete your signup:</p>\r\n      <p style=\"font-size: 1.5rem; letter-spacing: 6px;\"><strong>${code}</strong></p>\r\n      <p>This code expires in 60 seconds.</p>\r\n    </div>\r\n  `;\r\n\r\n  try {\r\n    // Verify transporter before sending (gives clearer auth/connection errors)\r\n    await verifyTransporter();\r\n\r\n    const info = await transporter.sendMail({\r\n      from: envelopeFrom,\r\n      to,\r\n      subject: \"Your verification code\",\r\n      html,\r\n      text: `Your OTP code is ${code} (valid 60 seconds)`,\r\n    });\r\n\r\n    console.log(\"[mail] sendMail success:\", {\r\n      messageId: info.messageId,\r\n      accepted: info.accepted,\r\n      rejected: info.rejected,\r\n    });\r\n\r\n    return info;\r\n  } catch (err) {\r\n    console.error(\"[mail] sendMail error:\", err);\r\n    throw err;\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,kBAAkB;;;;;;;;;AAClB;;AAEA,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS,IAAI;AACtC,MAAM,OAAO,OAAO,QAAQ,GAAG,CAAC,SAAS,IAAI;AAC7C,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS,IAAI;AACtC,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS,IAAI;AACtC,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS,IAAK,QAAQ,CAAC,kBAAkB,CAAC;AAEnE,SAAS;IACP,MAAM,SAAS,SAAS,KAAK,sBAAsB;IACnD,MAAM,OAAO,OAAO;QAAE;QAAM;IAAK,IAAI;IAErC,MAAM,cAAc,4JAAU,CAAC,eAAe,CAAC;QAC7C;QACA;QACA;QACA;QACA,0FAA0F;QAC1F,uCAAuC;QACvC,KAAK;YACH,oBAAoB,sCAAwC,0BAAO;QACrE;QACA,wDAAwD;QACxD,mBAAmB;IACrB;IAEA,OAAO;AACT;AAEO,MAAM,cAAc;AAMpB,eAAe;IACpB,IAAI;QACF,MAAM,KAAK,MAAM,YAAY,MAAM;QACnC,QAAQ,GAAG,CAAC,gCAAgC;QAC5C,OAAO;IACT,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,2CAA2C;QACzD,MAAM;IACR;AACF;AAMO,eAAe,aAAa,EAAU,EAAE,IAAY;IACzD,QAAQ,GAAG,CAAC,0BAA0B;QAAE;QAAI;QAAM;QAAM,MAAM,CAAC,CAAC;IAAK;IAErE,IAAI,CAAC,IAAI,MAAM,IAAI,MAAM;IAEzB,+BAA+B;IAC/B,MAAM,eAAe,QAAQ,CAAC,OAAO,OAAO,oBAAoB;IAEhE,MAAM,OAAO,CAAC;;;;iEAIiD,EAAE,KAAK;;;EAGtE,CAAC;IAED,IAAI;QACF,2EAA2E;QAC3E,MAAM;QAEN,MAAM,OAAO,MAAM,YAAY,QAAQ,CAAC;YACtC,MAAM;YACN;YACA,SAAS;YACT;YACA,MAAM,CAAC,iBAAiB,EAAE,KAAK,mBAAmB,CAAC;QACrD;QAEA,QAAQ,GAAG,CAAC,4BAA4B;YACtC,WAAW,KAAK,SAAS;YACzB,UAAU,KAAK,QAAQ;YACvB,UAAU,KAAK,QAAQ;QACzB;QAEA,OAAO;IACT,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,0BAA0B;QACxC,MAAM;IACR;AACF","debugId":null}},
    {"offset": {"line": 255, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/app/api/auth/send-otp/route.ts"],"sourcesContent":["// src/app/api/auth/send-otp/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { sendOTPEmail } from \"@/lib/mail\";\r\nimport bcrypt from \"bcrypt\";\r\n\r\nconst OTP_LENGTH = 6;\r\nconst OTP_TTL_MS = 10 * 60 * 1000; // 10 minutes\r\n\r\nfunction generateOtp(length = OTP_LENGTH) {\r\n  const min = 10 ** (length - 1);\r\n  const max = 10 ** length - 1;\r\n  return Math.floor(min + Math.random() * (max - min + 1)).toString();\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json().catch(() => ({}));\r\n    const email = (body?.email || \"\").toString().trim().toLowerCase();\r\n    if (!email) {\r\n      return NextResponse.json({ error: \"Email required\" }, { status: 400 });\r\n    }\r\n\r\n    // generate OTP and hash\r\n    const otp = generateOtp();\r\n    const codeHash = await bcrypt.hash(otp, 10);\r\n    const expiresAt = new Date(Date.now() + OTP_TTL_MS);\r\n\r\n    // Use upsert so we either create or update the row atomically.\r\n    // This assumes your EmailOtp model has unique constraint on `email` or you use a unique `id`.\r\n    // If `email` is not unique in the schema, prisma.upsert with `where: { email }` will fail.\r\n    // In that case we fall back to findFirst + update/create below.\r\n    try {\r\n      await prisma.emailOtp.upsert({\r\n        where: { email }, // requires email to be unique in schema\r\n        update: { otp, codeHash, expiresAt, verified: false },\r\n        create: { email, otp, codeHash, expiresAt, verified: false },\r\n      });\r\n    } catch (e) {\r\n      // if upsert fails because `email` isn't unique in schema, fallback to findFirst logic\r\n      const existing = await prisma.emailOtp.findFirst({ where: { email } });\r\n      if (existing) {\r\n        await prisma.emailOtp.update({\r\n          where: { id: existing.id },\r\n          data: { otp, codeHash, expiresAt, verified: false },\r\n        });\r\n      } else {\r\n        await prisma.emailOtp.create({\r\n          data: { email, otp, codeHash, expiresAt, verified: false },\r\n        });\r\n      }\r\n    }\r\n\r\n    // send OTP email (let caller know of failures separately)\r\n    await sendOTPEmail(email, otp);\r\n\r\n    return NextResponse.json({ ok: true, message: \"OTP sent\" });\r\n  } catch (err) {\r\n    console.error(\"send-otp error:\", err);\r\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,qCAAqC;;;;;AACrC;AACA;AACA;AACA;;;;;AAEA,MAAM,aAAa;AACnB,MAAM,aAAa,KAAK,KAAK,MAAM,aAAa;AAEhD,SAAS,YAAY,SAAS,UAAU;IACtC,MAAM,MAAM,MAAM,CAAC,SAAS,CAAC;IAC7B,MAAM,MAAM,MAAM,SAAS;IAC3B,OAAO,KAAK,KAAK,CAAC,MAAM,KAAK,MAAM,KAAK,CAAC,MAAM,MAAM,CAAC,GAAG,QAAQ;AACnE;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC7C,MAAM,QAAQ,CAAC,MAAM,SAAS,EAAE,EAAE,QAAQ,GAAG,IAAI,GAAG,WAAW;QAC/D,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,wBAAwB;QACxB,MAAM,MAAM;QACZ,MAAM,WAAW,MAAM,gHAAM,CAAC,IAAI,CAAC,KAAK;QACxC,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK;QAExC,+DAA+D;QAC/D,8FAA8F;QAC9F,2FAA2F;QAC3F,gEAAgE;QAChE,IAAI;YACF,MAAM,gIAAM,CAAC,QAAQ,CAAC,MAAM,CAAC;gBAC3B,OAAO;oBAAE;gBAAM;gBACf,QAAQ;oBAAE;oBAAK;oBAAU;oBAAW,UAAU;gBAAM;gBACpD,QAAQ;oBAAE;oBAAO;oBAAK;oBAAU;oBAAW,UAAU;gBAAM;YAC7D;QACF,EAAE,OAAO,GAAG;YACV,sFAAsF;YACtF,MAAM,WAAW,MAAM,gIAAM,CAAC,QAAQ,CAAC,SAAS,CAAC;gBAAE,OAAO;oBAAE;gBAAM;YAAE;YACpE,IAAI,UAAU;gBACZ,MAAM,gIAAM,CAAC,QAAQ,CAAC,MAAM,CAAC;oBAC3B,OAAO;wBAAE,IAAI,SAAS,EAAE;oBAAC;oBACzB,MAAM;wBAAE;wBAAK;wBAAU;wBAAW,UAAU;oBAAM;gBACpD;YACF,OAAO;gBACL,MAAM,gIAAM,CAAC,QAAQ,CAAC,MAAM,CAAC;oBAC3B,MAAM;wBAAE;wBAAO;wBAAK;wBAAU;wBAAW,UAAU;oBAAM;gBAC3D;YACF;QACF;QAEA,0DAA0D;QAC1D,MAAM,IAAA,oIAAY,EAAC,OAAO;QAE1B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM,SAAS;QAAW;IAC3D,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,mBAAmB;QACjC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF","debugId":null}}]
}