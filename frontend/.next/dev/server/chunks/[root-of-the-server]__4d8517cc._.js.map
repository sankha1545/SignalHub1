{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/app/api/invites/finalize/route.ts"],"sourcesContent":["// src/app/api/invites/finalize/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport { PrismaClient } from \"@prisma/client\";\r\nimport bcrypt from \"bcryptjs\";\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nfunction validatePassword(p: string) {\r\n  return typeof p === \"string\" && p.length >= 8;\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const { token, username, password } = await req.json();\r\n    if (!token) return NextResponse.json({ ok: false, message: \"Missing token\" }, { status: 400 });\r\n    if (!username || typeof username !== \"string\") return NextResponse.json({ ok: false, message: \"Invalid username\" }, { status: 400 });\r\n    if (!validatePassword(password)) return NextResponse.json({ ok: false, message: \"Password must be at least 8 characters\" }, { status: 400 });\r\n\r\n    const invite = await prisma.invite.findUnique({ where: { token } });\r\n    if (!invite) return NextResponse.json({ ok: false, message: \"Invalid invite token\" }, { status: 404 });\r\n    if (invite.acceptedAt) return NextResponse.json({ ok: false, message: \"Invite already used\" }, { status: 410 });\r\n    if (new Date(invite.expiresAt) < new Date()) return NextResponse.json({ ok: false, message: \"Invite expired\" }, { status: 410 });\r\n\r\n    // ensure email isn't already used\r\n    const existing = await prisma.user.findUnique({ where: { email: invite.email } });\r\n    if (existing) return NextResponse.json({ ok: false, message: \"Account already exists for this email\" }, { status: 409 });\r\n\r\n    const passwordHash = await bcrypt.hash(password, 10);\r\n\r\n    const user = await prisma.user.create({\r\n      data: {\r\n        email: invite.email,\r\n        username,\r\n        passwordHash,\r\n        emailVerified: true,    // skip email verification (admin already verified)\r\n        phoneVerified: true,    // skip phone verification\r\n        // add other fields if needed\r\n      },\r\n    });\r\n\r\n    // mark invite accepted\r\n    await prisma.invite.update({ where: { id: invite.id }, data: { acceptedAt: new Date() } });\r\n\r\n    // Optionally create profile or send welcome email...\r\n\r\n    return NextResponse.json({ ok: true, message: \"Account created\" });\r\n  } catch (err: any) {\r\n    console.error(\"invites/finalize error:\", err);\r\n    return NextResponse.json({ ok: false, message: err?.message || \"Server error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,wCAAwC;;;;;AACxC;AACA;AACA;;;;AAEA,MAAM,SAAS,IAAI,6IAAY;AAE/B,SAAS,iBAAiB,CAAS;IACjC,OAAO,OAAO,MAAM,YAAY,EAAE,MAAM,IAAI;AAC9C;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAI,IAAI;QACpD,IAAI,CAAC,OAAO,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,SAAS;QAAgB,GAAG;YAAE,QAAQ;QAAI;QAC5F,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,SAAS;QAAmB,GAAG;YAAE,QAAQ;QAAI;QAClI,IAAI,CAAC,iBAAiB,WAAW,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,SAAS;QAAyC,GAAG;YAAE,QAAQ;QAAI;QAE1I,MAAM,SAAS,MAAM,OAAO,MAAM,CAAC,UAAU,CAAC;YAAE,OAAO;gBAAE;YAAM;QAAE;QACjE,IAAI,CAAC,QAAQ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,SAAS;QAAuB,GAAG;YAAE,QAAQ;QAAI;QACpG,IAAI,OAAO,UAAU,EAAE,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,SAAS;QAAsB,GAAG;YAAE,QAAQ;QAAI;QAC7G,IAAI,IAAI,KAAK,OAAO,SAAS,IAAI,IAAI,QAAQ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,SAAS;QAAiB,GAAG;YAAE,QAAQ;QAAI;QAE9H,kCAAkC;QAClC,MAAM,WAAW,MAAM,OAAO,IAAI,CAAC,UAAU,CAAC;YAAE,OAAO;gBAAE,OAAO,OAAO,KAAK;YAAC;QAAE;QAC/E,IAAI,UAAU,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,SAAS;QAAwC,GAAG;YAAE,QAAQ;QAAI;QAEtH,MAAM,eAAe,MAAM,8IAAM,CAAC,IAAI,CAAC,UAAU;QAEjD,MAAM,OAAO,MAAM,OAAO,IAAI,CAAC,MAAM,CAAC;YACpC,MAAM;gBACJ,OAAO,OAAO,KAAK;gBACnB;gBACA;gBACA,eAAe;gBACf,eAAe;YAEjB;QACF;QAEA,uBAAuB;QACvB,MAAM,OAAO,MAAM,CAAC,MAAM,CAAC;YAAE,OAAO;gBAAE,IAAI,OAAO,EAAE;YAAC;YAAG,MAAM;gBAAE,YAAY,IAAI;YAAO;QAAE;QAExF,qDAAqD;QAErD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM,SAAS;QAAkB;IAClE,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,SAAS,KAAK,WAAW;QAAe,GAAG;YAAE,QAAQ;QAAI;IACjG;AACF","debugId":null}}]
}