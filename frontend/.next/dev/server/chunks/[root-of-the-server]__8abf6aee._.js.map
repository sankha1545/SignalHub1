{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/lib/prisma.ts"],"sourcesContent":["// lib/prisma.ts\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line\r\n  var __prisma__: PrismaClient | undefined;\r\n}\r\nexport const prisma =\r\n  global.__prisma__ ??\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"warn\", \"error\"] : [\"error\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") global.__prisma__ = prisma;\r\n"],"names":[],"mappings":"AAAA,gBAAgB;;;;;AAChB;;AAMO,MAAM,SACX,OAAO,UAAU,IACjB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAQ;KAAQ,GAAG;AAC7E;AAEF,wCAA2C,OAAO,UAAU,GAAG","debugId":null}},
    {"offset": {"line": 77, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/app/api/invites/finalize/route.ts"],"sourcesContent":["// src/app/api/invites/finalize/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport bcrypt from \"bcryptjs\";\r\nimport { prisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * POST /api/invites/finalize\r\n *\r\n * Accepts:\r\n *   { token?: string, password: string, name?: string, phone?: string, phoneVerified?: boolean }\r\n * or Authorization: Bearer <token>\r\n *\r\n * Behavior:\r\n *  - Validate token + password\r\n *  - Ensure invite exists, not expired, not already accepted\r\n *  - Ensure invite.email is not already registered under another org (prevent overlap)\r\n *  - Create user in a transaction, attach organization from invite\r\n *  - Create Profile and TeamMember (if invite.teamId present)\r\n *  - Mark invite.acceptedAt and status = ACCEPTED in same transaction\r\n *  - Return 201 with userId/email/organizationId on success\r\n */\r\n\r\nfunction validatePassword(p: unknown) {\r\n  return typeof p === \"string\" && p.length >= 8;\r\n}\r\nfunction validateName(n: unknown) {\r\n  return n === undefined || (typeof n === \"string\" && n.trim().length > 0 && n.trim().length <= 200);\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    // parse body defensively\r\n    let body: any = {};\r\n    try {\r\n      body = (await req.json()) || {};\r\n    } catch {\r\n      body = {};\r\n    }\r\n\r\n    // token: body.token or Authorization: Bearer <token>\r\n    let token: string | null =\r\n      typeof body?.token === \"string\" && body.token.trim() ? body.token.trim() : null;\r\n    if (!token) {\r\n      const auth = req.headers.get(\"authorization\") || req.headers.get(\"Authorization\");\r\n      if (auth && typeof auth === \"string\" && auth.toLowerCase().startsWith(\"bearer \")) {\r\n        token = auth.slice(7).trim();\r\n      }\r\n    }\r\n\r\n    if (!token) {\r\n      return NextResponse.json(\r\n        { ok: false, message: \"Missing invite token (provide body.token or Authorization: Bearer <token>)\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const password = body?.password;\r\n    if (!validatePassword(password)) {\r\n      return NextResponse.json(\r\n        { ok: false, message: \"Invalid password â€” must be at least 8 characters.\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const name = typeof body?.name === \"string\" && body.name.trim() ? body.name.trim() : undefined;\r\n    if (!validateName(name)) {\r\n      return NextResponse.json({ ok: false, message: \"Invalid name\" }, { status: 400 });\r\n    }\r\n\r\n    const phone = typeof body?.phone === \"string\" && body.phone.trim() ? body.phone.trim() : undefined;\r\n    // client-provided phoneVerified is advisory; we will set phoneVerified=true for invited MANAGERs\r\n    const phoneVerifiedFlag = !!body?.phoneVerified;\r\n\r\n    const now = new Date();\r\n\r\n    // Transactional flow: verify invite, ensure uniqueness, create user/profile/teamMember, mark invite accepted\r\n    const result = await prisma.$transaction(async (tx) => {\r\n      // load invite\r\n      const invite = await tx.invite.findUnique({ where: { token } });\r\n      if (!invite) throw { code: \"INVITE_NOT_FOUND\" };\r\n\r\n      // expired?\r\n      if (invite.expiresAt && invite.expiresAt.getTime() <= now.getTime()) throw { code: \"INVITE_EXPIRED\" };\r\n\r\n      // used?\r\n      if (invite.acceptedAt) throw { code: \"INVITE_ALREADY_USED\" };\r\n\r\n      // ensure invite has target email\r\n      const invitedEmail = (invite.email || \"\").trim().toLowerCase();\r\n      if (!invitedEmail) throw { code: \"INVITE_MISSING_EMAIL\" };\r\n\r\n      // ensure email not already registered under another org\r\n      const existing = await tx.user.findUnique({ where: { email: invitedEmail } });\r\n      if (existing) {\r\n        // If existing user belongs to a different organization -> conflict\r\n        if (existing.organizationId && invite.organizationId && existing.organizationId !== invite.organizationId) {\r\n          throw { code: \"EMAIL_EXISTS_OTHER_ORG\" };\r\n        }\r\n        // If existing user is already part of same organization, treat as conflict (account exists)\r\n        throw { code: \"EMAIL_ALREADY_REGISTERED\" };\r\n      }\r\n\r\n      // ensure invite.organization exists\r\n      if (!invite.organizationId) throw { code: \"INVITE_MISSING_ORG\" };\r\n      const org = await tx.organization.findUnique({ where: { id: invite.organizationId } });\r\n      if (!org) throw { code: \"INVITE_ORG_NOT_FOUND\" };\r\n\r\n      // hash password\r\n      const passwordHash = await bcrypt.hash(String(password), 10);\r\n\r\n      // determine role & verification flags\r\n      const roleFromInvite = (invite.role || \"EMPLOYEE\") as string; // Role enum string\r\n      const isManager = roleFromInvite === \"MANAGER\" || roleFromInvite === \"Manager\" || roleFromInvite === \"manager\";\r\n\r\n      // Build create payload for User\r\n      const createUserData: any = {\r\n        email: invitedEmail,\r\n        passwordHash,\r\n        name: name ?? null,\r\n        provider: \"email\",\r\n        emailVerified: true, // trusted because invite was issued by admin\r\n        role: roleFromInvite,\r\n        organization: { connect: { id: invite.organizationId } },\r\n        isActive: true,\r\n      };\r\n\r\n      // Phone: attach if provided. For invited managers, we set phoneVerified = true to bypass phone gating.\r\n      if (phone) {\r\n        createUserData.phone = phone;\r\n        createUserData.phoneVerified = isManager ? true : !!phoneVerifiedFlag;\r\n      } else if (isManager) {\r\n        // invited manager with no phone in invite: still allow creation but phoneVerified remains false\r\n        // (we avoid forcing a value)\r\n      }\r\n\r\n      // Create user\r\n      const newUser = await tx.user.create({ data: createUserData });\r\n\r\n      // Create Profile with phone metadata if appropriate\r\n      const profileData: any = {\r\n        userId: newUser.id,\r\n        displayName: name ?? undefined,\r\n      };\r\n      if (phone) {\r\n        profileData.phoneNumber = phone;\r\n        profileData.phoneVerified = isManager ? true : !!phoneVerifiedFlag;\r\n        if (profileData.phoneVerified) profileData.phoneVerifiedAt = now;\r\n      }\r\n      await tx.profile.create({ data: profileData });\r\n\r\n      // If invite.teamId present, add TeamMember record (if team exists)\r\n      if (invite.teamId) {\r\n        const teamExists = await tx.team.findUnique({ where: { id: invite.teamId } });\r\n        if (teamExists) {\r\n          // create membership (role defaults to EMPLOYEE; invite.role may override)\r\n          await tx.teamMember.create({\r\n            data: {\r\n              teamId: invite.teamId,\r\n              userId: newUser.id,\r\n              role: (invite.role as any) ?? \"EMPLOYEE\",\r\n            },\r\n          });\r\n        }\r\n      }\r\n\r\n      // Mark invite accepted\r\n      await tx.invite.update({\r\n        where: { id: invite.id },\r\n        data: { acceptedAt: now, status: \"ACCEPTED\" },\r\n      });\r\n\r\n      return { userId: newUser.id, email: newUser.email, organizationId: invite.organizationId ?? null };\r\n    });\r\n\r\n    return NextResponse.json({ ok: true, message: \"Account created\", ...result }, { status: 201 });\r\n  } catch (err: any) {\r\n    // map thrown codes from transaction\r\n    if (err && typeof err === \"object\" && \"code\" in err) {\r\n      switch (err.code) {\r\n        case \"INVITE_NOT_FOUND\":\r\n          return NextResponse.json({ ok: false, message: \"Invalid invite token\" }, { status: 404 });\r\n        case \"INVITE_EXPIRED\":\r\n          return NextResponse.json({ ok: false, message: \"Invite expired\" }, { status: 410 });\r\n        case \"INVITE_ALREADY_USED\":\r\n          return NextResponse.json({ ok: false, message: \"Invite already used\" }, { status: 410 });\r\n        case \"INVITE_MISSING_EMAIL\":\r\n          return NextResponse.json({ ok: false, message: \"Invite missing target email\" }, { status: 500 });\r\n        case \"EMAIL_ALREADY_REGISTERED\":\r\n          return NextResponse.json({ ok: false, message: \"Account already exists for this email\" }, { status: 409 });\r\n        case \"EMAIL_EXISTS_OTHER_ORG\":\r\n          return NextResponse.json(\r\n            { ok: false, message: \"An account with this email exists under another organization\" },\r\n            { status: 409 }\r\n          );\r\n        case \"INVITE_MISSING_ORG\":\r\n          return NextResponse.json({ ok: false, message: \"Invite missing organization\" }, { status: 400 });\r\n        case \"INVITE_ORG_NOT_FOUND\":\r\n          return NextResponse.json({ ok: false, message: \"Invite organization not found\" }, { status: 404 });\r\n        default:\r\n          break;\r\n      }\r\n    }\r\n\r\n    // Prisma unique constraint (extra safety)\r\n    if (err && err.code === \"P2002\" && Array.isArray(err?.meta?.target)) {\r\n      const target = (err.meta.target as string[]).join(\", \");\r\n      console.error(\"[invites/finalize] Prisma unique constraint error:\", target, err);\r\n      return NextResponse.json({ ok: false, message: `Unique constraint failed: ${target}` }, { status: 409 });\r\n    }\r\n\r\n    console.error(\"[invites/finalize] Fatal error:\", err);\r\n    const isDev = process.env.NODE_ENV !== \"production\";\r\n    return NextResponse.json({ ok: false, message: isDev ? (err?.message || String(err)) : \"Server error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}