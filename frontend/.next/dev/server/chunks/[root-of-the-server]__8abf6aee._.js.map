{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/lib/prisma.ts"],"sourcesContent":["// lib/prisma.ts\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line\r\n  var __prisma__: PrismaClient | undefined;\r\n}\r\nexport const prisma =\r\n  global.__prisma__ ??\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"warn\", \"error\"] : [\"error\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") global.__prisma__ = prisma;\r\n"],"names":[],"mappings":"AAAA,gBAAgB;;;;;AAChB;;AAMO,MAAM,SACX,OAAO,UAAU,IACjB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAQ;KAAQ,GAAG;AAC7E;AAEF,wCAA2C,OAAO,UAAU,GAAG","debugId":null}},
    {"offset": {"line": 77, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/app/api/invites/finalize/route.ts"],"sourcesContent":["// src/app/api/invites/finalize/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport bcrypt from \"bcryptjs\";\r\nimport { prisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * POST /api/invites/finalize\r\n *\r\n * Accepts JSON:\r\n *  { token?: string, password: string, name?: string, phone?: string, phoneVerified?: boolean }\r\n * OR Authorization: Bearer <token> header + JSON body { password: \"...\", ... }\r\n *\r\n * Behavior:\r\n *  - Validate token + password\r\n *  - Ensure invite exists, not expired, not already accepted\r\n *  - Ensure invite.email is not already registered\r\n *  - Create user in a transaction, attach organization/team from invite if present\r\n *  - Mark invite.acceptedAt and status in same transaction\r\n *  - Return 201 with userId/email on success\r\n */\r\n\r\nfunction validatePassword(p: unknown) {\r\n  return typeof p === \"string\" && p.length >= 8;\r\n}\r\nfunction validateName(n: unknown) {\r\n  return n === undefined || (typeof n === \"string\" && n.trim().length > 0 && n.trim().length <= 200);\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    // parse body (defensive)\r\n    let body: any = {};\r\n    try {\r\n      body = (await req.json()) || {};\r\n    } catch {\r\n      body = {};\r\n    }\r\n\r\n    // token: body.token or Authorization: Bearer <token>\r\n    let token: string | null = typeof body?.token === \"string\" && body.token.trim() ? body.token.trim() : null;\r\n    if (!token) {\r\n      const auth = req.headers.get(\"authorization\") || req.headers.get(\"Authorization\");\r\n      if (auth && typeof auth === \"string\" && auth.toLowerCase().startsWith(\"bearer \")) {\r\n        token = auth.slice(7).trim();\r\n      }\r\n    }\r\n\r\n    if (!token) {\r\n      return NextResponse.json({ ok: false, message: \"Missing invite token (provide body.token or Authorization: Bearer <token>)\" }, { status: 400 });\r\n    }\r\n\r\n    const password = body?.password;\r\n    if (!validatePassword(password)) {\r\n      return NextResponse.json({ ok: false, message: \"Invalid password â€” must be at least 8 characters.\" }, { status: 400 });\r\n    }\r\n\r\n    const name = typeof body?.name === \"string\" && body.name.trim() ? body.name.trim() : undefined;\r\n    if (!validateName(name)) {\r\n      return NextResponse.json({ ok: false, message: \"Invalid name\" }, { status: 400 });\r\n    }\r\n\r\n    const phone = typeof body?.phone === \"string\" && body.phone.trim() ? body.phone.trim() : undefined;\r\n    const phoneVerifiedFlag = !!body?.phoneVerified;\r\n\r\n    const now = new Date();\r\n\r\n    const result = await prisma.$transaction(async (tx) => {\r\n      // load invite\r\n      const invite = await tx.invite.findUnique({ where: { token } });\r\n      if (!invite) throw { code: \"INVITE_NOT_FOUND\" };\r\n\r\n      // expired?\r\n      if (invite.expiresAt && invite.expiresAt.getTime() <= now.getTime()) throw { code: \"INVITE_EXPIRED\" };\r\n\r\n      // used?\r\n      if (invite.acceptedAt) throw { code: \"INVITE_ALREADY_USED\" };\r\n\r\n      // ensure invite has target email\r\n      const invitedEmail = (invite.email || \"\").trim().toLowerCase();\r\n      if (!invitedEmail) throw { code: \"INVITE_MISSING_EMAIL\" };\r\n\r\n      // ensure email not already registered\r\n      const existing = await tx.user.findUnique({ where: { email: invitedEmail } });\r\n      if (existing) throw { code: \"EMAIL_ALREADY_REGISTERED\" };\r\n\r\n      // hash password\r\n      const passwordHash = await bcrypt.hash(String(password), 10);\r\n\r\n      // build create payload (do not include unknown fields like `username`)\r\n      const createData: any = {\r\n        email: invitedEmail,\r\n        passwordHash,\r\n        name: name ?? null,\r\n        provider: \"email\",\r\n        emailVerified: true, // trusted via invite\r\n        role: invite.role ?? \"MEMBER\",\r\n      };\r\n\r\n      if (phone) {\r\n        createData.phone = phone;\r\n        if (phoneVerifiedFlag) createData.phoneVerified = true;\r\n      }\r\n\r\n      if (invite.organizationId) {\r\n        createData.organization = { connect: { id: invite.organizationId } };\r\n      }\r\n      if (invite.teamId) {\r\n        createData.team = { connect: { id: invite.teamId } };\r\n      }\r\n\r\n      // create user\r\n      const newUser = await tx.user.create({ data: createData });\r\n\r\n      // mark invite accepted (single-use)\r\n      await tx.invite.update({\r\n        where: { id: invite.id },\r\n        data: { acceptedAt: new Date(), status: \"ACCEPTED\" as any },\r\n      });\r\n\r\n      return { userId: newUser.id, email: newUser.email, organizationId: invite.organizationId ?? null };\r\n    });\r\n\r\n    return NextResponse.json({ ok: true, message: \"Account created\", ...result }, { status: 201 });\r\n  } catch (err: any) {\r\n    // map thrown codes from transaction\r\n    if (err && typeof err === \"object\" && \"code\" in err) {\r\n      switch (err.code) {\r\n        case \"INVITE_NOT_FOUND\":\r\n          return NextResponse.json({ ok: false, message: \"Invalid invite token\" }, { status: 404 });\r\n        case \"INVITE_EXPIRED\":\r\n          return NextResponse.json({ ok: false, message: \"Invite expired\" }, { status: 410 });\r\n        case \"INVITE_ALREADY_USED\":\r\n          return NextResponse.json({ ok: false, message: \"Invite already used\" }, { status: 410 });\r\n        case \"INVITE_MISSING_EMAIL\":\r\n          return NextResponse.json({ ok: false, message: \"Invite missing target email\" }, { status: 500 });\r\n        case \"EMAIL_ALREADY_REGISTERED\":\r\n          return NextResponse.json({ ok: false, message: \"Account already exists for this email\" }, { status: 409 });\r\n        default:\r\n          break;\r\n      }\r\n    }\r\n\r\n    // Prisma unique constraint (extra safety)\r\n    if (err && err.code === \"P2002\" && Array.isArray(err?.meta?.target)) {\r\n      const target = (err.meta.target as string[]).join(\", \");\r\n      console.error(\"[invites/finalize] Prisma unique constraint error:\", target, err);\r\n      return NextResponse.json({ ok: false, message: `Unique constraint failed: ${target}` }, { status: 409 });\r\n    }\r\n\r\n    console.error(\"[invites/finalize] Fatal error:\", err);\r\n    const isDev = process.env.NODE_ENV !== \"production\";\r\n    return NextResponse.json({ ok: false, message: isDev ? (err?.message || String(err)) : \"Server error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,wCAAwC;;;;;AACxC;AACA;AACA;;;;AAEA;;;;;;;;;;;;;;CAcC,GAED,SAAS,iBAAiB,CAAU;IAClC,OAAO,OAAO,MAAM,YAAY,EAAE,MAAM,IAAI;AAC9C;AACA,SAAS,aAAa,CAAU;IAC9B,OAAO,MAAM,aAAc,OAAO,MAAM,YAAY,EAAE,IAAI,GAAG,MAAM,GAAG,KAAK,EAAE,IAAI,GAAG,MAAM,IAAI;AAChG;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,yBAAyB;QACzB,IAAI,OAAY,CAAC;QACjB,IAAI;YACF,OAAO,AAAC,MAAM,IAAI,IAAI,MAAO,CAAC;QAChC,EAAE,OAAM;YACN,OAAO,CAAC;QACV;QAEA,qDAAqD;QACrD,IAAI,QAAuB,OAAO,MAAM,UAAU,YAAY,KAAK,KAAK,CAAC,IAAI,KAAK,KAAK,KAAK,CAAC,IAAI,KAAK;QACtG,IAAI,CAAC,OAAO;YACV,MAAM,OAAO,IAAI,OAAO,CAAC,GAAG,CAAC,oBAAoB,IAAI,OAAO,CAAC,GAAG,CAAC;YACjE,IAAI,QAAQ,OAAO,SAAS,YAAY,KAAK,WAAW,GAAG,UAAU,CAAC,YAAY;gBAChF,QAAQ,KAAK,KAAK,CAAC,GAAG,IAAI;YAC5B;QACF;QAEA,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAO,SAAS;YAA6E,GAAG;gBAAE,QAAQ;YAAI;QAC/I;QAEA,MAAM,WAAW,MAAM;QACvB,IAAI,CAAC,iBAAiB,WAAW;YAC/B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAO,SAAS;YAAoD,GAAG;gBAAE,QAAQ;YAAI;QACtH;QAEA,MAAM,OAAO,OAAO,MAAM,SAAS,YAAY,KAAK,IAAI,CAAC,IAAI,KAAK,KAAK,IAAI,CAAC,IAAI,KAAK;QACrF,IAAI,CAAC,aAAa,OAAO;YACvB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAO,SAAS;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACjF;QAEA,MAAM,QAAQ,OAAO,MAAM,UAAU,YAAY,KAAK,KAAK,CAAC,IAAI,KAAK,KAAK,KAAK,CAAC,IAAI,KAAK;QACzF,MAAM,oBAAoB,CAAC,CAAC,MAAM;QAElC,MAAM,MAAM,IAAI;QAEhB,MAAM,SAAS,MAAM,gIAAM,CAAC,YAAY,CAAC,OAAO;YAC9C,cAAc;YACd,MAAM,SAAS,MAAM,GAAG,MAAM,CAAC,UAAU,CAAC;gBAAE,OAAO;oBAAE;gBAAM;YAAE;YAC7D,IAAI,CAAC,QAAQ,MAAM;gBAAE,MAAM;YAAmB;YAE9C,WAAW;YACX,IAAI,OAAO,SAAS,IAAI,OAAO,SAAS,CAAC,OAAO,MAAM,IAAI,OAAO,IAAI,MAAM;gBAAE,MAAM;YAAiB;YAEpG,QAAQ;YACR,IAAI,OAAO,UAAU,EAAE,MAAM;gBAAE,MAAM;YAAsB;YAE3D,iCAAiC;YACjC,MAAM,eAAe,CAAC,OAAO,KAAK,IAAI,EAAE,EAAE,IAAI,GAAG,WAAW;YAC5D,IAAI,CAAC,cAAc,MAAM;gBAAE,MAAM;YAAuB;YAExD,sCAAsC;YACtC,MAAM,WAAW,MAAM,GAAG,IAAI,CAAC,UAAU,CAAC;gBAAE,OAAO;oBAAE,OAAO;gBAAa;YAAE;YAC3E,IAAI,UAAU,MAAM;gBAAE,MAAM;YAA2B;YAEvD,gBAAgB;YAChB,MAAM,eAAe,MAAM,8IAAM,CAAC,IAAI,CAAC,OAAO,WAAW;YAEzD,uEAAuE;YACvE,MAAM,aAAkB;gBACtB,OAAO;gBACP;gBACA,MAAM,QAAQ;gBACd,UAAU;gBACV,eAAe;gBACf,MAAM,OAAO,IAAI,IAAI;YACvB;YAEA,IAAI,OAAO;gBACT,WAAW,KAAK,GAAG;gBACnB,IAAI,mBAAmB,WAAW,aAAa,GAAG;YACpD;YAEA,IAAI,OAAO,cAAc,EAAE;gBACzB,WAAW,YAAY,GAAG;oBAAE,SAAS;wBAAE,IAAI,OAAO,cAAc;oBAAC;gBAAE;YACrE;YACA,IAAI,OAAO,MAAM,EAAE;gBACjB,WAAW,IAAI,GAAG;oBAAE,SAAS;wBAAE,IAAI,OAAO,MAAM;oBAAC;gBAAE;YACrD;YAEA,cAAc;YACd,MAAM,UAAU,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC;gBAAE,MAAM;YAAW;YAExD,oCAAoC;YACpC,MAAM,GAAG,MAAM,CAAC,MAAM,CAAC;gBACrB,OAAO;oBAAE,IAAI,OAAO,EAAE;gBAAC;gBACvB,MAAM;oBAAE,YAAY,IAAI;oBAAQ,QAAQ;gBAAkB;YAC5D;YAEA,OAAO;gBAAE,QAAQ,QAAQ,EAAE;gBAAE,OAAO,QAAQ,KAAK;gBAAE,gBAAgB,OAAO,cAAc,IAAI;YAAK;QACnG;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM,SAAS;YAAmB,GAAG,MAAM;QAAC,GAAG;YAAE,QAAQ;QAAI;IAC9F,EAAE,OAAO,KAAU;QACjB,oCAAoC;QACpC,IAAI,OAAO,OAAO,QAAQ,YAAY,UAAU,KAAK;YACnD,OAAQ,IAAI,IAAI;gBACd,KAAK;oBACH,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,IAAI;wBAAO,SAAS;oBAAuB,GAAG;wBAAE,QAAQ;oBAAI;gBACzF,KAAK;oBACH,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,IAAI;wBAAO,SAAS;oBAAiB,GAAG;wBAAE,QAAQ;oBAAI;gBACnF,KAAK;oBACH,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,IAAI;wBAAO,SAAS;oBAAsB,GAAG;wBAAE,QAAQ;oBAAI;gBACxF,KAAK;oBACH,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,IAAI;wBAAO,SAAS;oBAA8B,GAAG;wBAAE,QAAQ;oBAAI;gBAChG,KAAK;oBACH,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,IAAI;wBAAO,SAAS;oBAAwC,GAAG;wBAAE,QAAQ;oBAAI;gBAC1G;oBACE;YACJ;QACF;QAEA,0CAA0C;QAC1C,IAAI,OAAO,IAAI,IAAI,KAAK,WAAW,MAAM,OAAO,CAAC,KAAK,MAAM,SAAS;YACnE,MAAM,SAAS,AAAC,IAAI,IAAI,CAAC,MAAM,CAAc,IAAI,CAAC;YAClD,QAAQ,KAAK,CAAC,sDAAsD,QAAQ;YAC5E,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAO,SAAS,CAAC,0BAA0B,EAAE,QAAQ;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACxG;QAEA,QAAQ,KAAK,CAAC,mCAAmC;QACjD,MAAM,QAAQ,oDAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,SAAS,uCAAS,KAAK,WAAW,OAAO,OAAQ;QAAe,GAAG;YAAE,QAAQ;QAAI;IACzH;AACF","debugId":null}}]
}