{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/lib/prisma.ts"],"sourcesContent":["// lib/prisma.ts\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line\r\n  var __prisma__: PrismaClient | undefined;\r\n}\r\nexport const prisma =\r\n  global.__prisma__ ??\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"warn\", \"error\"] : [\"error\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") global.__prisma__ = prisma;\r\n"],"names":[],"mappings":"AAAA,gBAAgB;;;;;AAChB;;AAMO,MAAM,SACX,OAAO,UAAU,IACjB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAQ;KAAQ,GAAG;AAC7E;AAEF,wCAA2C,OAAO,UAAU,GAAG","debugId":null}},
    {"offset": {"line": 101, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/lib/jwt.ts"],"sourcesContent":["// src/lib/jwt.ts\r\nimport jwt, { JwtPayload } from \"jsonwebtoken\";\r\n\r\nconst SECRET = process.env.JWT_SECRET;\r\nif (!SECRET) {\r\n  if (process.env.NODE_ENV === \"production\") {\r\n    throw new Error(\"JWT_SECRET environment variable must be set in production!\");\r\n  } else {\r\n    console.warn(\"[JWT] Using fallback secret for development\");\r\n  }\r\n}\r\n\r\n/**\r\n * üîê Create a short-lived temp token (email/phone verification)\r\n */\r\nexport function signTemp(payload: Record<string, any>, expiresIn: string = \"15m\"): string {\r\n  const safePayload = { ...payload };\r\n  delete safePayload.exp;\r\n  return jwt.sign(safePayload, SECRET!, { expiresIn });\r\n}\r\n\r\n/**\r\n * ‚úÖ Verify short-lived temp tokens\r\n * Returns payload object or null if invalid/expired\r\n */\r\nexport function verifyTemp(token: string): Record<string, any> | null {\r\n  try {\r\n    return jwt.verify(token, SECRET!) as Record<string, any>;\r\n  } catch (err) {\r\n    console.warn(\"[JWT] verifyTemp failed:\", (err as Error).message);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * üíæ Create a long-lived session token for logged-in users\r\n */\r\nexport function signSession(payload: Record<string, any>, expiresIn: string = \"7d\"): string {\r\n  const safePayload = { ...payload };\r\n  delete safePayload.exp;\r\n  return jwt.sign(safePayload, SECRET!, { expiresIn });\r\n}\r\n\r\n/**\r\n * üîé Verify a session token\r\n * Returns payload object or null if invalid/expired\r\n */\r\nexport function verifySession(token: string): Record<string, any> | null {\r\n  try {\r\n    return jwt.verify(token, SECRET!) as Record<string, any>;\r\n  } catch (err) {\r\n    console.warn(\"[JWT] verifySession failed:\", (err as Error).message);\r\n    return null;\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,iBAAiB;;;;;;;;;;;AACjB;;AAEA,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU;AACrC,IAAI,CAAC,QAAQ;IACX;;SAEO;QACL,QAAQ,IAAI,CAAC;IACf;AACF;AAKO,SAAS,SAAS,OAA4B,EAAE,YAAoB,KAAK;IAC9E,MAAM,cAAc;QAAE,GAAG,OAAO;IAAC;IACjC,OAAO,YAAY,GAAG;IACtB,OAAO,kJAAG,CAAC,IAAI,CAAC,aAAa,QAAS;QAAE;IAAU;AACpD;AAMO,SAAS,WAAW,KAAa;IACtC,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAO,KAAK;QACZ,QAAQ,IAAI,CAAC,4BAA4B,AAAC,IAAc,OAAO;QAC/D,OAAO;IACT;AACF;AAKO,SAAS,YAAY,OAA4B,EAAE,YAAoB,IAAI;IAChF,MAAM,cAAc;QAAE,GAAG,OAAO;IAAC;IACjC,OAAO,YAAY,GAAG;IACtB,OAAO,kJAAG,CAAC,IAAI,CAAC,aAAa,QAAS;QAAE;IAAU;AACpD;AAMO,SAAS,cAAc,KAAa;IACzC,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAO,KAAK;QACZ,QAAQ,IAAI,CAAC,+BAA+B,AAAC,IAAc,OAAO;QAClE,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 160, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/app/api/auth/login/route.ts"],"sourcesContent":["// app/api/auth/login/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport bcrypt from \"bcrypt\";\r\nimport { signSession } from \"@/lib/jwt\";\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const { email, phone, password } = await req.json();\r\n\r\n    if ((!email && !phone) || !password) {\r\n      return NextResponse.json({ error: \"missing_credentials\" }, { status: 400 });\r\n    }\r\n\r\n    // Find user by email or phone\r\n    let user;\r\n    if (email) {\r\n      user = await prisma.user.findUnique({ where: { email } });\r\n    } else if (phone) {\r\n      user = await prisma.user.findFirst({ where: { phone } });\r\n    }\r\n\r\n    if (!user || !user.passwordHash) {\r\n      return NextResponse.json({ error: \"invalid_credentials\" }, { status: 401 });\r\n    }\r\n\r\n    // Compare password\r\n    const isPasswordValid = await bcrypt.compare(password, user.passwordHash);\r\n    if (!isPasswordValid) {\r\n      return NextResponse.json({ error: \"invalid_credentials\" }, { status: 401 });\r\n    }\r\n\r\n    // --- Enforce both verifications (phone AND email) ---\r\n    const phoneVerified = Boolean(user.phoneVerified);\r\n    const emailVerified = Boolean(user.emailVerified);\r\n\r\n    if (!phoneVerified || !emailVerified) {\r\n      // Provide specific details to help the client show the right UX\r\n      return NextResponse.json(\r\n        {\r\n          error: \"account_not_fully_verified\",\r\n          details: { phoneVerified, emailVerified },\r\n        },\r\n        { status: 403 }\r\n      );\r\n    }\r\n    // ----------------------------------------------------\r\n\r\n    // Sign session JWT - include both keys for compatibility\r\n    const sessionToken = signSession(\r\n      {\r\n        id: user.id,\r\n        role: user.role,\r\n        organizationId: user.organizationId,\r\n        org: user.organizationId,\r\n      },\r\n      \"7d\"\r\n    );\r\n\r\n    // Set cookie\r\n    const maxAge = 7 * 24 * 60 * 60; // 7 days\r\n    const isProd = process.env.NODE_ENV === \"production\";\r\n    const cookieParts = [\r\n      `session=${sessionToken}`,\r\n      `Path=/`,\r\n      `Max-Age=${maxAge}`,\r\n      `HttpOnly`,\r\n      `SameSite=Lax`,\r\n    ];\r\n    if (isProd) cookieParts.push(\"Secure\");\r\n    const cookie = cookieParts.join(\"; \");\r\n\r\n    return NextResponse.json(\r\n      {\r\n        ok: true,\r\n        user: { id: user.id, email: user.email, phone: user.phone, role: user.role },\r\n      },\r\n      { headers: { \"Set-Cookie\": cookie } }\r\n    );\r\n  } catch (err: any) {\r\n    console.error(\"[Login Error]\", err);\r\n    return NextResponse.json({ error: err.message || \"internal_server_error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,8BAA8B;;;;;AAC9B;AACA;AACA;AACA;;;;;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAI,IAAI;QAEjD,IAAI,AAAC,CAAC,SAAS,CAAC,SAAU,CAAC,UAAU;YACnC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC3E;QAEA,8BAA8B;QAC9B,IAAI;QACJ,IAAI,OAAO;YACT,OAAO,MAAM,gIAAM,CAAC,IAAI,CAAC,UAAU,CAAC;gBAAE,OAAO;oBAAE;gBAAM;YAAE;QACzD,OAAO,IAAI,OAAO;YAChB,OAAO,MAAM,gIAAM,CAAC,IAAI,CAAC,SAAS,CAAC;gBAAE,OAAO;oBAAE;gBAAM;YAAE;QACxD;QAEA,IAAI,CAAC,QAAQ,CAAC,KAAK,YAAY,EAAE;YAC/B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC3E;QAEA,mBAAmB;QACnB,MAAM,kBAAkB,MAAM,gHAAM,CAAC,OAAO,CAAC,UAAU,KAAK,YAAY;QACxE,IAAI,CAAC,iBAAiB;YACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC3E;QAEA,uDAAuD;QACvD,MAAM,gBAAgB,QAAQ,KAAK,aAAa;QAChD,MAAM,gBAAgB,QAAQ,KAAK,aAAa;QAEhD,IAAI,CAAC,iBAAiB,CAAC,eAAe;YACpC,gEAAgE;YAChE,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,OAAO;gBACP,SAAS;oBAAE;oBAAe;gBAAc;YAC1C,GACA;gBAAE,QAAQ;YAAI;QAElB;QACA,uDAAuD;QAEvD,yDAAyD;QACzD,MAAM,eAAe,IAAA,kIAAW,EAC9B;YACE,IAAI,KAAK,EAAE;YACX,MAAM,KAAK,IAAI;YACf,gBAAgB,KAAK,cAAc;YACnC,KAAK,KAAK,cAAc;QAC1B,GACA;QAGF,aAAa;QACb,MAAM,SAAS,IAAI,KAAK,KAAK,IAAI,SAAS;QAC1C,MAAM,SAAS,oDAAyB;QACxC,MAAM,cAAc;YAClB,CAAC,QAAQ,EAAE,cAAc;YACzB,CAAC,MAAM,CAAC;YACR,CAAC,QAAQ,EAAE,QAAQ;YACnB,CAAC,QAAQ,CAAC;YACV,CAAC,YAAY,CAAC;SACf;QACD;;QACA,MAAM,SAAS,YAAY,IAAI,CAAC;QAEhC,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,IAAI;YACJ,MAAM;gBAAE,IAAI,KAAK,EAAE;gBAAE,OAAO,KAAK,KAAK;gBAAE,OAAO,KAAK,KAAK;gBAAE,MAAM,KAAK,IAAI;YAAC;QAC7E,GACA;YAAE,SAAS;gBAAE,cAAc;YAAO;QAAE;IAExC,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,iBAAiB;QAC/B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO,IAAI;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC5F;AACF","debugId":null}}]
}