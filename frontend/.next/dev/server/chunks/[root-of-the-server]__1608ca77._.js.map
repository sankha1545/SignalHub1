{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/lib/prisma.ts"],"sourcesContent":["// lib/prisma.ts\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line\r\n  var __prisma__: PrismaClient | undefined;\r\n}\r\nexport const prisma =\r\n  global.__prisma__ ??\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"warn\", \"error\"] : [\"error\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") global.__prisma__ = prisma;\r\n"],"names":[],"mappings":"AAAA,gBAAgB;;;;;AAChB;;AAMO,MAAM,SACX,OAAO,UAAU,IACjB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAQ;KAAQ,GAAG;AAC7E;AAEF,wCAA2C,OAAO,UAAU,GAAG","debugId":null}},
    {"offset": {"line": 71, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/app/api/invites/accept/route.ts"],"sourcesContent":["// src/app/api/invites/accept/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * Accept an invite token and return the email and role for signup\r\n *\r\n * Flow:\r\n * - Token must exist in request body\r\n * - Token must exist in DB\r\n * - Token must not be expired (if expiresAt is set)\r\n * - Token must not be already used (acceptedAt is null)\r\n * - The invite email must not already belong to an existing user (global uniqueness)\r\n *\r\n * The endpoint returns invite metadata needed by the frontend to prefill the signup form:\r\n * { ok, email, role, organizationId, organizationName, teamId, expiresAt, createdAt }\r\n */\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const payload = await req.json();\r\n    const token = payload?.token;\r\n\r\n    // Basic validation\r\n    if (!token || typeof token !== \"string\" || token.trim().length === 0) {\r\n      return NextResponse.json(\r\n        { ok: false, message: \"Missing or invalid token\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const normalizedToken = token.trim();\r\n\r\n    // Lookup invite, include organization name when available\r\n    const invite = await prisma.invite.findUnique({\r\n      where: { token: normalizedToken },\r\n      include: {\r\n        organization: {\r\n          select: { id: true, name: true },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!invite) {\r\n      return NextResponse.json(\r\n        { ok: false, message: \"Invalid invite token\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Check if invite was already accepted\r\n    if (invite.acceptedAt) {\r\n      return NextResponse.json(\r\n        { ok: false, message: \"Invite already used\" },\r\n        { status: 410 }\r\n      );\r\n    }\r\n\r\n    // Check expiry if set\r\n    if (invite.expiresAt && invite.expiresAt.getTime() < Date.now()) {\r\n      return NextResponse.json(\r\n        { ok: false, message: \"Invite expired\" },\r\n        { status: 410 }\r\n      );\r\n    }\r\n\r\n    // Defensive: ensure invite has an email\r\n    if (!invite.email || typeof invite.email !== \"string\") {\r\n      return NextResponse.json(\r\n        { ok: false, message: \"Invite missing target email\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    const inviteEmail = invite.email.trim().toLowerCase();\r\n\r\n    // IMPORTANT: ensure the invite email is not already used by any user in the system\r\n    // This enforces \"once an email has been used for creating an account it cannot be used again\".\r\n    const existingUser = await prisma.user.findUnique({\r\n      where: { email: inviteEmail },\r\n    });\r\n\r\n    if (existingUser) {\r\n      // The invite cannot be used because the email is taken already.\r\n      // We do NOT automatically accept/consume the invite here — caller should handle remediation.\r\n      return NextResponse.json(\r\n        {\r\n          ok: false,\r\n          message: \"Email already in use\",\r\n          detail: \"The invited email is already registered in the system.\",\r\n        },\r\n        { status: 409 }\r\n      );\r\n    }\r\n\r\n    // Everything looks good — return useful invite metadata for frontend signup.\r\n    return NextResponse.json({\r\n      ok: true,\r\n      email: inviteEmail,\r\n      role: invite.role,\r\n      organizationId: invite.organizationId ?? null,\r\n      organizationName: invite.organization?.name ?? null,\r\n      teamId: invite.teamId ?? null,\r\n      // return timestamps in ISO so frontend can display them reliably\r\n      expiresAt: invite.expiresAt ? invite.expiresAt.toISOString() : null,\r\n      createdAt: invite.createdAt ? invite.createdAt.toISOString() : null,\r\n      message: \"Invite valid\",\r\n    });\r\n  } catch (err: any) {\r\n    console.error(\"invites/accept error:\", err);\r\n    return NextResponse.json(\r\n      { ok: false, message: err?.message || \"Server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,sCAAsC;;;;;AACtC;AACA;;;AAeO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,UAAU,MAAM,IAAI,IAAI;QAC9B,MAAM,QAAQ,SAAS;QAEvB,mBAAmB;QACnB,IAAI,CAAC,SAAS,OAAO,UAAU,YAAY,MAAM,IAAI,GAAG,MAAM,KAAK,GAAG;YACpE,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,SAAS;YAA2B,GACjD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,kBAAkB,MAAM,IAAI;QAElC,0DAA0D;QAC1D,MAAM,SAAS,MAAM,gIAAM,CAAC,MAAM,CAAC,UAAU,CAAC;YAC5C,OAAO;gBAAE,OAAO;YAAgB;YAChC,SAAS;gBACP,cAAc;oBACZ,QAAQ;wBAAE,IAAI;wBAAM,MAAM;oBAAK;gBACjC;YACF;QACF;QAEA,IAAI,CAAC,QAAQ;YACX,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,SAAS;YAAuB,GAC7C;gBAAE,QAAQ;YAAI;QAElB;QAEA,uCAAuC;QACvC,IAAI,OAAO,UAAU,EAAE;YACrB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,SAAS;YAAsB,GAC5C;gBAAE,QAAQ;YAAI;QAElB;QAEA,sBAAsB;QACtB,IAAI,OAAO,SAAS,IAAI,OAAO,SAAS,CAAC,OAAO,KAAK,KAAK,GAAG,IAAI;YAC/D,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,SAAS;YAAiB,GACvC;gBAAE,QAAQ;YAAI;QAElB;QAEA,wCAAwC;QACxC,IAAI,CAAC,OAAO,KAAK,IAAI,OAAO,OAAO,KAAK,KAAK,UAAU;YACrD,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,SAAS;YAA8B,GACpD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,cAAc,OAAO,KAAK,CAAC,IAAI,GAAG,WAAW;QAEnD,mFAAmF;QACnF,+FAA+F;QAC/F,MAAM,eAAe,MAAM,gIAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YAChD,OAAO;gBAAE,OAAO;YAAY;QAC9B;QAEA,IAAI,cAAc;YAChB,gEAAgE;YAChE,6FAA6F;YAC7F,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,IAAI;gBACJ,SAAS;gBACT,QAAQ;YACV,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,6EAA6E;QAC7E,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,IAAI;YACJ,OAAO;YACP,MAAM,OAAO,IAAI;YACjB,gBAAgB,OAAO,cAAc,IAAI;YACzC,kBAAkB,OAAO,YAAY,EAAE,QAAQ;YAC/C,QAAQ,OAAO,MAAM,IAAI;YACzB,iEAAiE;YACjE,WAAW,OAAO,SAAS,GAAG,OAAO,SAAS,CAAC,WAAW,KAAK;YAC/D,WAAW,OAAO,SAAS,GAAG,OAAO,SAAS,CAAC,WAAW,KAAK;YAC/D,SAAS;QACX;IACF,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,IAAI;YAAO,SAAS,KAAK,WAAW;QAAe,GACrD;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}