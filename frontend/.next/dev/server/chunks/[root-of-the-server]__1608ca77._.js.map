{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/lib/prisma.ts"],"sourcesContent":["// lib/prisma.ts\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line\r\n  var __prisma__: PrismaClient | undefined;\r\n}\r\nexport const prisma =\r\n  global.__prisma__ ??\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"warn\", \"error\"] : [\"error\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") global.__prisma__ = prisma;\r\n"],"names":[],"mappings":"AAAA,gBAAgB;;;;;AAChB;;AAMO,MAAM,SACX,OAAO,UAAU,IACjB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAQ;KAAQ,GAAG;AAC7E;AAEF,wCAA2C,OAAO,UAAU,GAAG","debugId":null}},
    {"offset": {"line": 71, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attack%20Capital/SignalHub/frontend/src/app/api/invites/accept/route.ts"],"sourcesContent":["// src/app/api/invites/accept/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * Accept an invite token and return the email and role for signup.\r\n *\r\n * Supports:\r\n *  - GET  /api/invites/accept?token=...\r\n *  - POST { token: \"...\" }\r\n *  - Authorization: Bearer <token>\r\n *\r\n * Response (success):\r\n *  {\r\n *    ok: true,\r\n *    email,\r\n *    role,\r\n *    organizationId,\r\n *    organizationName,\r\n *    teamId,\r\n *    expiresAt,\r\n *    createdAt,\r\n *    preverifiedEmail: true,\r\n *    message: \"Invite valid\"\r\n *  }\r\n *\r\n * Error responses are JSON with { ok: false, message } and appropriate HTTP status.\r\n *\r\n * NOTE: This endpoint only *validates* the invite token and returns metadata for the\r\n * frontend to prefill signup. The invite should be consumed (create user + mark invite accepted)\r\n * by the /api/invites/finalize endpoint.\r\n */\r\n\r\n/* ---------- helpers ---------- */\r\n\r\nfunction jsonError(message: string, status = 400) {\r\n  return NextResponse.json({ ok: false, message }, { status });\r\n}\r\n\r\nasync function lookupInviteByToken(token: string) {\r\n  // token is expected to be stored plainly in DB as unique token.\r\n  // If you ever switch to hashed tokens, replace this with hash compare logic.\r\n  return prisma.invite.findUnique({\r\n    where: { token },\r\n    include: { organization: { select: { id: true, name: true } } },\r\n  });\r\n}\r\n\r\n/* ---------- GET handler (token via query) ---------- */\r\nexport async function GET(req: Request) {\r\n  try {\r\n    const url = new URL(req.url);\r\n    const token = (url.searchParams.get(\"token\") || \"\").trim();\r\n\r\n    if (!token) return jsonError(\"Missing invite token\", 400);\r\n    if (token.length < 16) return jsonError(\"Invalid invite token\", 400);\r\n\r\n    const invite = await lookupInviteByToken(token);\r\n    if (!invite) return jsonError(\"Invalid invite token\", 404);\r\n\r\n    // Already accepted?\r\n    if (invite.acceptedAt) return jsonError(\"Invite already used\", 410);\r\n\r\n    // Expiry check\r\n    if (invite.expiresAt && invite.expiresAt.getTime() < Date.now()) return jsonError(\"Invite expired\", 410);\r\n\r\n    // Email sanity\r\n    if (!invite.email || typeof invite.email !== \"string\") return jsonError(\"Invite missing target email\", 500);\r\n    const inviteEmail = invite.email.trim().toLowerCase();\r\n\r\n    // Organization sanity\r\n    if (!invite.organizationId)\r\n      return jsonError(\"Invite missing organization reference\", 500);\r\n    const org = invite.organization ?? (await prisma.organization.findUnique({ where: { id: invite.organizationId } }));\r\n    if (!org) return jsonError(\"Organization not found\", 404);\r\n\r\n    // Team -> org consistency\r\n    if (invite.teamId) {\r\n      const team = await prisma.team.findUnique({\r\n        where: { id: invite.teamId },\r\n        select: { id: true, organizationId: true },\r\n      });\r\n      if (!team) return jsonError(\"Invited team not found\", 404);\r\n      if (team.organizationId !== invite.organizationId) {\r\n        return jsonError(\"Invited team does not belong to invite's organization\", 400);\r\n      }\r\n    }\r\n\r\n    // Ensure invite email not already registered\r\n    const existingUser = await prisma.user.findUnique({ where: { email: inviteEmail } });\r\n    if (existingUser) {\r\n      return NextResponse.json(\r\n        {\r\n          ok: false,\r\n          message: \"Email already in use\",\r\n          detail: \"The invited email is already registered in the system.\",\r\n        },\r\n        { status: 409 }\r\n      );\r\n    }\r\n\r\n    // Successful response (frontend expects these fields)\r\n    return NextResponse.json({\r\n      ok: true,\r\n      email: inviteEmail,\r\n      role: invite.role ?? null,\r\n      organizationId: invite.organizationId ?? null,\r\n      organizationName: org?.name ?? null,\r\n      teamId: invite.teamId ?? null,\r\n      expiresAt: invite.expiresAt ? invite.expiresAt.toISOString() : null,\r\n      createdAt: invite.createdAt ? invite.createdAt.toISOString() : null,\r\n      preverifiedEmail: true, // invited addresses are treated as pre-verified\r\n      message: \"Invite valid\",\r\n    });\r\n  } catch (err: any) {\r\n    console.error(\"[invites/accept][GET] unexpected error:\", err);\r\n    const isDev = process.env.NODE_ENV !== \"production\";\r\n    return NextResponse.json(\r\n      { ok: false, message: isDev ? err?.message || \"Server error\" : \"Server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/* ---------- POST handler (token via JSON body or Authorization header) ---------- */\r\nexport async function POST(req: Request) {\r\n  try {\r\n    let payload: any = {};\r\n    try {\r\n      payload = (await req.json()) || {};\r\n    } catch {\r\n      payload = {};\r\n    }\r\n\r\n    // Token sources: body.token OR Authorization header\r\n    let token = typeof payload?.token === \"string\" ? payload.token.trim() : \"\";\r\n    if (!token) {\r\n      const auth = req.headers.get(\"authorization\") || req.headers.get(\"Authorization\") || \"\";\r\n      if (auth && typeof auth === \"string\" && auth.toLowerCase().startsWith(\"bearer \")) {\r\n        token = auth.slice(7).trim();\r\n      }\r\n    }\r\n\r\n    if (!token) return jsonError(\"Missing invite token\", 400);\r\n    if (token.length < 16) return jsonError(\"Invalid invite token\", 400);\r\n\r\n    const invite = await lookupInviteByToken(token);\r\n    if (!invite) return jsonError(\"Invalid invite token\", 404);\r\n\r\n    if (invite.acceptedAt) return jsonError(\"Invite already used\", 410);\r\n    if (invite.expiresAt && invite.expiresAt.getTime() < Date.now()) return jsonError(\"Invite expired\", 410);\r\n\r\n    if (!invite.email || typeof invite.email !== \"string\") return jsonError(\"Invite missing target email\", 500);\r\n    const inviteEmail = invite.email.trim().toLowerCase();\r\n\r\n    // Defensive org check\r\n    if (!invite.organizationId) return jsonError(\"Invite missing organization reference\", 500);\r\n    const org = invite.organization ?? (await prisma.organization.findUnique({ where: { id: invite.organizationId } }));\r\n    if (!org) return jsonError(\"Organization not found\", 404);\r\n\r\n    // Team -> org consistency\r\n    if (invite.teamId) {\r\n      const team = await prisma.team.findUnique({\r\n        where: { id: invite.teamId },\r\n        select: { id: true, organizationId: true },\r\n      });\r\n      if (!team) return jsonError(\"Invited team not found\", 404);\r\n      if (team.organizationId !== invite.organizationId) {\r\n        return jsonError(\"Invited team does not belong to invite's organization\", 400);\r\n      }\r\n    }\r\n\r\n    // Ensure invite email not already registered\r\n    const existingUser = await prisma.user.findUnique({ where: { email: inviteEmail } });\r\n    if (existingUser) {\r\n      return NextResponse.json(\r\n        {\r\n          ok: false,\r\n          message: \"Email already in use\",\r\n          detail: \"The invited email is already registered in the system.\",\r\n        },\r\n        { status: 409 }\r\n      );\r\n    }\r\n\r\n    // All good â€” return invite metadata\r\n    return NextResponse.json({\r\n      ok: true,\r\n      email: inviteEmail,\r\n      role: invite.role ?? null,\r\n      organizationId: invite.organizationId ?? null,\r\n      organizationName: org?.name ?? null,\r\n      teamId: invite.teamId ?? null,\r\n      expiresAt: invite.expiresAt ? invite.expiresAt.toISOString() : null,\r\n      createdAt: invite.createdAt ? invite.createdAt.toISOString() : null,\r\n      preverifiedEmail: true,\r\n      message: \"Invite valid\",\r\n    });\r\n  } catch (err: any) {\r\n    console.error(\"[invites/accept][POST] unexpected error:\", err);\r\n    const isDev = process.env.NODE_ENV !== \"production\";\r\n    return NextResponse.json(\r\n      { ok: false, message: isDev ? err?.message || \"Server error\" : \"Server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/* Explicitly reject other methods */\r\nexport function PUT() {\r\n  return NextResponse.json({ ok: false, message: \"Method not allowed\" }, { status: 405 });\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}